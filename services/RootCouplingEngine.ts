
import { GameHistoryItem, DomainType } from '../types';

export interface УзелСцепки {
    домен1: DomainType;
    домен2: DomainType;
    силаСвязи: number; // 0-100
    тип: 'СИМБИОЗ' | 'ПАРАЗИТ' | 'КОНФЛИКТ';
    описание: string;
}

export interface ОтчетСцепки {
    узлы: УзелСцепки[];
    индексСцепленности: number;
    главныйУзел: [DomainType, DomainType] | null;
    вердикт: string;
}

/**
 * ГЕНЕЗИС: ЯДРО КОРНЕВОЙ СЦЕПКИ v1.0
 * Детерминированный поиск системных "мертвых петель" (Ст. 1.1)
 */
export const RootCouplingEngine = {
    рассчитать(история: GameHistoryItem[]): ОтчетСцепки {
        const домены: DomainType[] = ['foundation', 'agency', 'money', 'social', 'legacy'];
        const узлы: УзелСцепки[] = [];
        
        // Анализируем кросс-доменные паттерны (Ст. 4.2)
        for (let i = 0; i < домены.length; i++) {
            for (let j = i + 1; j < домены.length; j++) {
                const d1 = домены[i];
                const d2 = домены[j];
                
                const блоки1 = история.filter(h => h.domain === d1 && h.latency > 2500).length;
                const блоки2 = история.filter(h => h.domain === d2 && h.latency > 2500).length;
                
                // Сила сцепки = корреляция тяжелых ответов между сферами
                const сила = Math.min(100, (блоки1 + блоки2) * 10);
                
                if (сила > 30) {
                    let тип: УзелСцепки['тип'] = 'СИМБИОЗ';
                    let описание = "Сферы поддерживают друг друга в статике.";
                    
                    if (сила > 70) {
                        тип = 'КОНФЛИКТ';
                        описание = "Жесткая взаимная блокировка. Изменение в одной сфере вызывает саботаж в другой.";
                    } else if (блоки1 > блоки2 * 2) {
                        тип = 'ПАРАЗИТ';
                        описание = `Домен ${d1} истощает ресурс домена ${d2}.`;
                    }

                    узлы.push({ домен1: d1, домен2: d2, силаСвязи: сила, тип, описание });
                }
            }
        }

        const индекс = узлы.length > 0 
            ? Math.round(узлы.reduce((acc, u) => acc + u.силаСвязи, 0) / узлы.length)
            : 0;

        const отсортированные = [...узлы].sort((a, b) => b.силаСвязи - a.силаСвязи);
        const главный = отсортированные.length > 0 ? [отсортированные[0].домен1, отсортированные[0].домен2] as [DomainType, DomainType] : null;

        let вердикт = "Система децентрализована. Свободное распределение ресурса.";
        if (индекс > 60) вердикт = "СИСТЕМНЫЙ КЛИНЧ: Домены заблокированы в жесткой связке. Прямые изменения невозможны без размыкания узла.";
        else if (узлы.length > 3) вердикт = "ВЫСОКАЯ СЦЕПЛЕННОСТЬ: Множественные зависимости затрудняют фокусировку на целях.";

        return {
            узлы: отсортированные,
            индексСцепленности: индекс,
            главныйУзел: главный,
            вердикт
        };
    }
};
