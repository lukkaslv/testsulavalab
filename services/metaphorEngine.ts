
import { AnalysisResult } from '../types';

export interface MetaPattern {
    id: string;
    title: string;
    content: string;
    clinicalContext: string;
}

/**
 * Genesis OS Metaphor Engine v1.0 (Экзистенциальный Слой)
 * Детерминированное сопоставление векторов состояния с мифическими шифрами.
 */
export const MetaphorEngine = {
    getPatterns(result: AnalysisResult): MetaPattern[] {
        const { state, neuroSync: sync } = result;
        const { foundation: f, agency: a, resource: r, entropy: e } = state;
        const patterns: MetaPattern[] = [];

        // P1: Тирания Времени (Бегство в прошлое/будущее)
        if (f < 40 && e > 60) {
            patterns.push({
                id: 'P1',
                title: "Тирания Времени",
                content: "Побег из «ада» настоящего в фантазии о прошлом или будущем. Единственный выход — мужественный «Спуск в преисподнюю» настоящего момента.",
                clinicalContext: "Низкая Опора + Высокий Хаос. Дискретность восприятия 'здесь и сейчас'."
            });
        }

        // P2: Ловушка Фарисея (Маска вместо правды)
        if (a > 80 && sync < 40) {
            patterns.push({
                id: 'P2',
                title: "Ловушка Фарисея",
                content: "Одержимое внимание к внешним правилам и поддержание 'идеальной' персоны ценой внутренней физиологической и духовной правды.",
                clinicalContext: "Гипер-контроль + Соматический разрыв. Моральная ригидность как защита."
            });
        }

        // P6: Две Боли (Скальпель против Гангрены)
        if (r < 30 && e > 50) {
            patterns.push({
                id: 'P6',
                title: "Две Боли",
                content: "Различение Трансформирующего Страдания (Боль бутона, становящегося цветком) и Застойного Страдания (Тупая боль души, гниющей в болоте жалости к себе).",
                clinicalContext: "Ресурсное истощение + Высокая Энтропия. Необходимость выбора вектора боли."
            });
        }

        // P16: Подавленный Эрос (Блок витальности)
        if (sync < 35 && a < 45) {
            patterns.push({
                id: 'P16',
                title: "Подавленный Эрос",
                content: "Систематическое торможение сексуальной энергии — первичного неврологического регулятора. Блок превращает источник исцеления в источник стресса.",
                clinicalContext: "Низкая когерентность + Дефицит воли. Хронический телесный зажим."
            });
        }

        // P22: Трон Тирана (Власть Эго)
        if (a > 90 && f < 30) {
            patterns.push({
                id: 'P22',
                title: "Трон Тирана",
                content: "Чрезмерная идентификация с контролирующим неокортексом (Эго). «Я» правит психикой железным кулаком, подавляя спонтанную мудрость тела.",
                clinicalContext: "Критический дисбаланс Воля/Фундамент. Диктатура ума."
            });
        }

        // P29: Бесконечная Интеграция (Мета-защита)
        if (result.integrity > 80 && e < 20) {
            patterns.push({
                id: 'P29',
                title: "Бесконечная Интеграция",
                content: "Страх прибытия. Импульс постоянно «улучшать инструмент» становится защитой от того, чтобы начать его использовать. Бегство в «становление» от «бытия».",
                clinicalContext: "Высокая целостность при стагнации. Страх финала и ответственности."
            });
        }

        // Если ничего не подошло (редко), даем базовый шифр
        if (patterns.length === 0) {
            patterns.push({
                id: 'P10',
                title: "Узкие Врата",
                content: "Сопротивление необходимой 'смерти' эго, предшествующей расширению. Вы цепляетесь за известное, потому что неизвестное ощущается как уничтожение.",
                clinicalContext: "Стадия перехода. Инерция гомеостаза."
            });
        }

        return patterns.slice(0, 3);
    }
};
