
import { GameHistoryItem, DomainType } from '../types';

export interface УзелРитма {
    номер: number;
    когерентность: number; // 0-100%
    домен: DomainType;
    тревога: boolean;
}

export interface ОтчетРитма {
    волны: УзелРитма[];
    средняяСтабильность: number;
    пикиДиссоциации: number;
    вердикт: string;
}

/**
 * ГЕНЕЗИС: ЯДРО РИТМОГРАММЫ v1.0
 * Детерминированный анализ временных рядов (Ст. 1.1)
 */
export const ConnectionEngine = {
    анализировать(история: GameHistoryItem[]): ОтчетРитма {
        if (история.length < 5) {
            return { волны: [], средняяСтабильность: 100, пикиДиссоциации: 0, вердикт: "Недостаточно данных" };
        }

        const волны: УзелРитма[] = история.map((h, i) => {
            // Когерентность = 100 - (Штраф за латентность + Штраф за соматику)
            const штрафЛатентности = h.latency > 3000 ? Math.min(50, (h.latency - 1500) / 100) : 0;
            const штрафСоматики = (h.sensation === 's1' || h.sensation === 's4') ? 40 : h.sensation === 's0' ? 10 : 0;
            
            const когерентность = Math.max(5, 100 - (штрафЛатентности + штрафСоматики));
            
            return {
                номер: i + 1,
                когерентность: Math.round(когерентность),
                домен: h.domain,
                тревога: когерентность < 40
            };
        });

        const средняя = Math.round(волны.reduce((acc, v) => acc + v.когерентность, 0) / волны.length);
        const пики = волны.filter(v => v.тревога).length;

        let вердикт = "Сигнал стабилен. Высокая осознанность.";
        if (пики > 10) вердикт = "КРИТИЧЕСКАЯ ДИССOЦИАЦИЯ: Клиент теряет контакт с телом при нагрузке.";
        else if (средняя < 60) вердикт = "НИЗКИЙ ТОНУС СВЯЗИ: Психика работает в режиме 'автопилота'.";
        else if (пики > 0) вердикт = "ТОЧЕЧНЫЕ РАЗРЫВЫ: Сопротивление локализовано в конкретных темах.";

        return {
            волны,
            средняяСтабильность: средняя,
            пикиДиссоциации: пики,
            вердикт
        };
    }
};
