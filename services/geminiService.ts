
import { AnalysisResult } from "../types";

// Genesis OS v3.9 - Professional Clinical Supervisor (COMPLIANT GRADE)
// Deterministic Expert System for Supervisor Protocols.
// TERMINOLOGY GUARD: No medical diagnoses (ICD-11/DSM-5) used.

const SUPERVISOR_PATTERNS = {
  ru: {
    critical_foundation: {
      obs: "ПАТТЕРН: 'ОГОЛЕННЫЙ НЕРВ'. Система фиксирует значительный дефицит внутренних опор (Foundation < 35). Это состояние характеризуется высокой чувствительностью к внешним изменениям и отсутствием внутреннего ресурса для контейнирования аффекта. Личность функционирует в режиме выживания, где любая неопределенность воспринимается как прямая угроза целостности.",
      risk: "ПРОГНОЗИРУЕМЫЕ РИСКИ: Высокая вероятность внезапного снижения работоспособности при росте нагрузки. Риск соматизации (отклик в теле вместо проживания чувств). Потребность во внешней фигуре, выполняющей роль 'психологического скелета'.",
      provocation: "ЦЕНТРАЛЬНАЯ ПРОВОКАЦИЯ: 'Что самое страшное в том, чтобы признать свою тотальную беспомощность перед другим человеком и позволить себе опереться на него?'",
      trap: "ТЕРАПЕВТИЧЕСКАЯ ЛОВУШКА: 'Слияние со Спасателем'. Клиент может бессознательно провоцировать специалиста на принятие опекающей роли, что блокирует развитие автономности.",
      transfer: "ПРОГНОЗ ПЕРЕНОСА: Ожидается поиск безусловного принятия. Любое установление границ (время, оплата) может восприниматься как отвержение.",
      tactics: "ТАКТИЧЕСКИЙ ПЛАН: 1. Максимальная стабильность сеттинга. 2. Валидация права на слабость и регресс. 3. Фокус на соматическом заземлении."
    },
    manic_defense: {
      obs: "ПАТТЕРН: 'ГИПЕР-МОБИЛИЗАЦИЯ'. Использование активности и сверх-достижений (Agency > 80) как способа избежать встречи с внутренним дефицитом (Foundation < 45). Эффективность здесь является не ресурсом, а способом защиты от тишины.",
      risk: "ПРОГНОЗИРУЕМЫЕ РИСКИ: Внезапное 'обрушение' активности при истощении биологического ресурса. Клиент игнорирует сигналы усталости до момента полного выгорания.",
      provocation: "КЛЮЧЕВАЯ ИНТЕРВЕНЦИЯ: 'От какой внутренней правды или от какого чувства вы бежите с такой невероятной скоростью?'",
      trap: "ТЕРАПЕВТИЧЕСКАЯ ЛОВУШКА: Подкрепление 'успешности' клиента вместо исследования того, что стоит за этой скоростью.",
      transfer: "ПРОГНОЗ ПЕРЕНОСА: Соревновательный перенос. Попытка 'победить' специалиста в скорости инсайтов.",
      tactics: "ТАКТИЧЕСКИЙ ПЛАН: 1. Конфронтация с темпом сессии. 2. Легализация права 'просто быть', а не 'функционировать'. 3. Исследование пауз и тишины."
    },
    frozen_state: {
      obs: "ПАТТЕРН: 'ПАРАЛИЗОВАННЫЙ ГИГАНТ'. Внутренний потенциал заблокирован высоким уровнем системного напряжения (Entropy). Энергия уходит не на развитие, а на сдерживание подавленных импульсов (чаще всего — гнева).",
      risk: "ПРОГНОЗИРУЕМЫЕ РИСКИ: Соматизация (мышечные зажимы, боли). Рост пассивной агрессии и самосаботажа в долгосрочных проектах.",
      provocation: "КЛЮЧЕВАЯ ИНТЕРВЕНЦИЯ: 'Против чего на самом деле направлена эта титаническая сила, которую вы так тщательно держите в узде?'",
      trap: "ТЕРАПЕВТИЧЕСКАЯ ЛОВУШКА: Увязание в бесконечном интеллектуальном анализе без перехода к чувствам и действиям.",
      transfer: "ПРОГНОЗ ПЕРЕНОСА: Пассивно-агрессивный перенос. Специалист может чувствовать иррациональное раздражение или сонливость на сессии.",
      tactics: "ТАКТИЧЕСКИЙ ПЛАН: 1. Легализация права на гнев. 2. Работа с вторичными выгодами от бездействия. 3. Фокус на амбивалентности."
    },
    dissociation: {
      obs: "ПАТТЕРН: 'МЕНТАЛЬНЫЙ ОТРЫВ'. Выраженное рассогласование между интеллектуальным анализом и телесным откликом (NeuroSync < 45). Клиент 'рассказывает' о себе, но не 'проживает' опыт.",
      risk: "ПРОГНОЗИРУЕМЫЕ РИСКИ: Принятие важных решений на основе социальных конструктов, а не внутренних потребностей. Глубинное чувство 'чужой жизни'.",
      provocation: "КЛЮЧЕВАЯ ИНТЕРВЕНЦИЯ: 'Если бы ваше тело могло говорить прямо сейчас, не спрашивая разрешения у вашего ума, что бы оно сказало?'",
      trap: "ТЕРАПЕВТИЧЕСКАЯ ЛОВУШКА: 'Формальный альянс' — клиент соглашается со всеми интерпретациями, но реальных изменений не происходит.",
      transfer: "ПРОГНОЗ ПЕРЕНОСА: Отношение к специалисту как к инструменту для починки функции, отсутствие эмоциональной связи.",
      tactics: "ТАКТИЧЕСКИЙ ПЛАН: 1. Радикальная соматическая фокусировка. 2. Остановка 'историй' и возврат в 'здесь и сейчас'."
    },
    stable: {
      obs: "ПАТТЕРН: 'КОНСЕРВАЦИЯ'. Система стабильна, но функционирует в рамках жесткого, безопасного сценария. Масштабирование саботируется ради сохранения предсказуемости.",
      risk: "ПРОГНОЗИРУЕМЫЕ РИСКИ: Стагнация, постепенное нарастание ощущения скуки и потери смыслов в жизни.",
      provocation: "КЛЮЧЕВАЯ ИНТЕРВЕНЦИЯ: 'Какой потенциал вы предаете, оставаясь в этой уютной, но тесной безопасности?'",
      trap: "ТЕРАПЕВТИЧЕСКАЯ ЛОВУШКА: Негласный договор 'просто говорить', избегая риска реальных изменений.",
      transfer: "ПРОГНОЗ ПЕРЕНОСА: Поиск одобрения специалистом текущей стратегии избегания.",
      tactics: "ТАКТИЧЕСКИЙ ПЛАН: 1. Исследование Тени (неприемлемых импульсов). 2. Работа с экзистенциальными темами свободы и выбора."
    },
    narcissistic_expansion: {
      obs: "ПАТТЕРН: 'ФАСАДНОЕ РАСШИРЕНИЕ'. Высокие амбиции при хрупком основании. Потребность в постоянном отражении своего успеха.",
      risk: "Острый стыд при столкновении с реальностью или неудачами. Склонность к обесцениванию помощи.",
      provocation: "Кто вы такой, когда на вас никто не смотрит и никто вами не восхищается?",
      trap: "Контрперенос: Ощущение собственной ничтожности рядом с грандиозным клиентом.",
      transfer: "Зеркальный перенос. Поиск подтверждения исключительности.",
      tactics: "1. Работа со стыдом. 2. Укрепление реального (не идеального) Я."
    },
    burnout_protocol: {
      obs: "ПАТТЕРН: 'КРИТИЧЕСКОЕ ИСТОЩЕНИЕ'. Тотальный упадок всех показателей при экстремальном уровне энтропии.",
      risk: "Риск декомпенсации. Необходимость бережной стабилизации и снижения любой когнитивной нагрузки.",
      provocation: "Что если 'сдаться' и перестать бороться — это сейчас самая смелая стратегия для выживания?",
      trap: "Вторичная выгода: Болезнь или слабость как единственный легальный способ получить отдых.",
      transfer: "Депрессивный фон переноса. Передача чувства безнадежности специалисту.",
      tactics: "1. Режим сохранения энергии. 2. Отмена достиженческих целей. 3. Контейнирование аффекта."
    },
    systemic_loyalty: {
      obs: "ПАТТЕРН: 'СИСТЕМНАЯ ВЕРНОСТЬ'. Бессознательная лояльность семейному сценарию дефицита или трудностей.",
      risk: "Саботаж успеха как способ не 'предавать' свою семью благополучием.",
      provocation: "Кому из ваших близких станет больно, если вы позволите себе быть по-настоящему свободным и богатым?",
      trap: "Вина выжившего: Клиенту трудно жить лучше, чем жили его предки.",
      transfer: "Попытка вовлечь специалиста в семейную систему как 'нового родственника'.",
      tactics: "1. Работа с генограммой. 2. Ритуалы разрешения на изменения."
    }
  },
  ka: { 
    critical_foundation: {
      obs: "პატერნი: 'გაშიშვლებული ნერვი'. შინაგანი საყრდენების დეფიციტი (Foundation < 35). სისტემა მუშაობს გადარჩენის რეჟიმში.",
      risk: "დეკომპენსაციის რისკი ნებისმიერი დატვირთვისას. სომატიზაციის მაღალი ალბათობა.",
      provocation: "რა არის ყველაზე საშინელი იმაში, რომ აღიაროთ თქვენი უმწეობა და მიენდოთ სხვას?",
      trap: "თერაპიული მახე: 'მშველელთან შერწყმა'.",
      transfer: "იდეალიზებული დედის ფიგურის ძიება.",
      tactics: "1. სეტინგის სტაბილურობა. 2. სომატური დამიწება."
    },
    manic_defense: {
      obs: "პატერნი: 'ჰიპერ-მობილიზაცია'. აქტივობა როგორც გაქცევის საშუალება (Agency > 80, Foundation < 45).",
      risk: "სრული გამოფიტვის რისკი. კლიენტი ვერ გრძნობს დაღლილობას.",
      provocation: "რა გრძნობისგან გარბიხართ ასეთი სისწრაფით?",
      trap: "კლიენტის 'წარმატებების' განმტკიცება მათი კვლევის ნაცვლად.",
      transfer: "შეჯიბრებითი გადაცემა.",
      tactics: "1. სესიის ტემპის შენელება. 2. სიჩუმის კვლევა."
    },
    frozen_state: {
      obs: "პატერნი: 'პარალიზებული გიგანტი'. რესურსი დაბლოკილია შინაგანი კონფლიქტით.",
      risk: "პასიური აგრესია და თვითსაბოტაჟი.",
      provocation: "ვისკენ არის მიმართული ეს ძალა, რომელსაც ასე საგულდაგულოდ აკავებთ?",
      trap: "ინტელექტუალური ანალიზი გრძნობებთან შეხვედრის ნაცვლად.",
      transfer: "პასიურ-აგრესიული გადაცემა.",
      tactics: "1. ბრაზის ლეგალიზაცია. 2. მეორადი სარგებლის კვლევა."
    },
    dissociation: {
      obs: "პატერნი: 'მენტალური მოწყვეტა'. გონებასა და სხეულს შორის კავშირის დარღვევა (NeuroSync < 45).",
      risk: "გადაწყვეტილებების მიღება შინაგანი გამოძახილის გარეშე.",
      provocation: "სხეულს რომ საუბარი შეეძლოს, რას იტყოდა ის ახლა?",
      trap: "ზედაპირული ალიანსი რეალური ცვლილებების გარეშე.",
      transfer: "ფუნქციონალური გადაცემა.",
      tactics: "1. სომატური ფოკუსირება. 2. აქ და ახლა-ში დაბრუნება."
    },
    stable: {
        obs: "პატერნი: 'კონსერვაცია'. სისტემა სტაბილურია, მაგრამ ზრდა დაბლოკილია უსაფრთხოების გამო.",
        risk: "სტაგნაცია და ცხოვრების აზრის დაკარგვა.",
        provocation: "რა პოტენციალს ღალატობთ ამ უსაფრთხოებაში დარჩენით?",
        trap: "კომფორტული თერაპია რეალური რისკების გარეშე.",
        transfer: "სპეციალისტისგან დასტურის ძიება.",
        tactics: "1. ჩრდილის კვლევა. 2. ეგზისტენციალური კონფრონტაცია."
    },
    narcissistic_expansion: { obs: "პატერნი: 'ფასადური გაფართოება'. ამბიციები მყიფე საყრდენებზე.", risk: "სირცხვილის განცდა წარუმატებლობისას.", provocation: "ვინ ხართ მაშინ, როცა არავინ გიყურებთ?", trap: "კონტრგადაცემა: საკუთარი უმნიშვნელობის განცდა კლიენტთან.", transfer: "სარკისებრი გადაცემა.", tactics: "1. სირცხვილზე მუშაობა. 2. რეალური მეს გამყარება." },
    burnout_protocol: { obs: "პატერნი: 'კრიტიკული გამოფიტვა'. ყველა მაჩვენებლის ვარდნა.", risk: "დეკომპენსაციის რისკი.", provocation: "იქნებ დანებება არის გადარჩენის საუკეთესო სტრატეგია?", trap: "მეორადი სარგებელი: სისუსტე როგორც დასვენების უფლება.", transfer: "უიმედობის განცდის გადაცემა.", tactics: "1. ენერგიის დაზოგვის რეჟიმი. 2. აფექტის კონტეინირება." },
    systemic_loyalty: { obs: "პატერნი: 'სისტემური ერთგულება'. ლოიალობა ოჯახური სცენარის მიმართ.", risk: "წარმატების საბოტაჟი ოჯახის 'ღალატის' შიშით.", provocation: "ვის ეტკინება თქვენი ოჯახიდან, თუ წარმატებული გახდებით?", trap: "გადარჩენილის დანაშაული.", transfer: "სპეციალისტის სისტემაში ჩართვა.", tactics: "1. გენოგრამაზე მუშაობა. 2. ნებართვის რიტუალები." }
  }
};

export const GeminiService = {
  async generateClinicalSupervision(result: AnalysisResult, lang: 'ru' | 'ka'): Promise<string> {
    await new Promise(resolve => setTimeout(resolve, 1500)); 

    const t = SUPERVISOR_PATTERNS[lang];
    const { state, neuroSync, activePatterns } = result;
    const f = state.foundation;
    const a = state.agency;
    const r = state.resource;
    const e = state.entropy;

    let patternKey: keyof typeof t = 'stable'; 
    
    if (f < 20 && e > 80) patternKey = 'burnout_protocol';
    else if (f < 35) patternKey = 'critical_foundation';
    else if (a > 80 && f < 45) patternKey = 'manic_defense';
    else if (a > 80 && r > 70 && f < 50) patternKey = 'narcissistic_expansion';
    else if (a < 35 && e > 45) patternKey = 'frozen_state';
    else if (neuroSync < 45) patternKey = 'dissociation';
    else if (activePatterns.includes('family_loyalty')) patternKey = 'systemic_loyalty';

    const pattern = t[patternKey];

    const reportTitle = lang === 'ru' ? "**КЛИНИЧЕСКИЙ ДОКЛАД СУПЕРВИЗОРА**" : "**სუპერვაიზერის კლინიკური მოხსენება**";
    const headers = lang === 'ru' ? 
        ["1. Клиническая картина", "2. Прогнозируемые риски", "3. Терапевтическая ловушка и контрперенос", "4. Ключевая интервенция (Провокация)", "5. Прогноз динамики переноса", "6. Тактический план на первые сессии"] : 
        ["1. კლინიკური სურათი", "2. პროგნოზირებადი რისკები", "3. თერაპიული ხაფანგი და კონტრგადაცემა", "4. საკვანძო ინტერვენცია (პროვოკაცია)", "5. გადაცემის დინამიკის პროგნოზი", "6. ტაქტიკური გეგმა პირველი სესიებისთვის"];

    let report = `${reportTitle}\n\n`;
    report += `**${headers[0]}:**\n${pattern.obs}\n\n`;
    report += `**${headers[1]}:**\n${pattern.risk}\n\n`;
    report += `**${headers[2]}:**\n${pattern.trap}\n\n`;
    report += `**${headers[3]}:**\n${pattern.provocation}\n\n`;
    
    if (pattern.transfer) {
        report += `**${headers[4]}:**\n${pattern.transfer}\n\n`;
    }
    if (pattern.tactics) {
        report += `**${headers[5]}:**\n${pattern.tactics}`;
    }

    return report;
  }
};
