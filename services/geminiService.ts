import { AnalysisResult } from "../types";

// Genesis OS v3.8 - Professional Clinical Supervisor (LAB GRADE)
// Deterministic Expert System for Supervisor Protocols.

const SUPERVISOR_PATTERNS = {
  ru: {
    critical_foundation: {
      obs: "КРИТИЧЕСКИЙ ДЕФИЦИТ ОПОР: Обнаружен износ несущих конструкций личности. Система работает в режиме выживания.",
      risk: "Высокий риск психосоматического обрушения или нервного истощения при малейшем повышении нагрузки.",
      provocation: "Если завтра вы перестанете быть 'полезным' и 'функционирующим', кто останется в этом пустом пространстве?",
      trap: "Ловушка 'Спасательства': Клиент будет пытаться сделать терапевта своей единственной опорой, саботируя рост.",
      transfer: "Клиент будет бессознательно искать фигуру 'Всемогущего Родителя'. Риск идеализации с последующим яростным обесцениванием.",
      tactics: "1. Стабилизация сеттинга. 2. Легализация беспомощности. 3. Возврат к соматическим опорам."
    },
    manic_defense: {
      obs: "МАНИАКАЛЬНАЯ ЗАЩИТА: Высокая Агентность (Воля) при пустом фундаменте. Бегство в деятельность от внутренней боли.",
      risk: "Внезапное депрессивное обрушение (Crash), когда компенсаторные механизмы исчерпают биологический ресурс.",
      provocation: "От какой именно тишины или внутренней боли вы бежите с такой огромной скоростью?",
      trap: "Терапевтический азарт: Терапевт может увлечься 'успехами' клиента, не замечая его нарастающего истощения.",
      transfer: "Соревновательный перенос. Клиент будет пытаться 'победить' терапевта в осознанности или скорости изменений.",
      tactics: "1. Конфронтация с темпом. 2. Замедление. 3. Фокус на 'пустоте' между достижениями."
    },
    frozen_state: {
      obs: "ЗАМОРОЖЕННЫЙ ПОТЕНЦИАЛ: Паралич воли на фоне высокой энтропии. Энергия системы тратится на сдерживание аффекта.",
      risk: "Аутоагрессия, соматизация (боли в теле без причины), хроническая усталость как способ не чувствовать ярость.",
      provocation: "Что самое страшное случится, если вы разрешите своей ярости выйти наружу хотя бы на секунду?",
      trap: "Интеллектуальный обход: Клиент будет бесконечно 'понимать' свои проблемы, используя это как защиту от действия.",
      transfer: "Пассивно-агрессивный перенос. Терапевт будет чувствовать бессилие и желание 'толкать' клиента.",
      tactics: "1. Работа с подавленным гневом. 2. Разрешение на 'не-изменение'. 3. Амбивалентность как фокус."
    },
    dissociation: {
      obs: "СОМАТИЧЕСКИЙ РАЗРЫВ: Отсутствие связи между когнитивным выбором и реакцией тела. Интеллектуализация как бункер.",
      risk: "Потеря контакта с реальностью потребностей. Выгорание, которое будет замечено слишком поздно.",
      provocation: "Опишите физическое ощущение вашего 'Я' прямо сейчас. Где именно оно заканчивается?",
      trap: "Формальный альянс: Клиент будет играть роль 'образцового пациента', но терапия не будет проникать вглубь.",
      transfer: "Выключенный перенос. Ощущение, что между терапевтом и клиентом 'стеклянная стена'.",
      tactics: "1. Соматическая фокусировка. 2. Прерывание потока речи. 3. Работа с 'здесь и сейчас' ощущениями."
    },
    narcissistic_expansion: {
      obs: "НАРЦИССИЧЕСКОЕ РАСШИРЕНИЕ: Высокий ресурс и воля при хрупких опорах. Потребность в постоянном подтверждении грандиозности.",
      risk: "Острый стыд при любой неудаче, обесценивание терапии и специалиста при столкновении с реальностью.",
      provocation: "Кто вы такой, когда на вас никто не смотрит и никто вами не восхищается?",
      trap: "Контрперенос: Терапевт может чувствовать себя либо ничтожным, либо ослепленным блеском клиента.",
      transfer: "Зеркальный перенос. Поиск в терапевте подтверждения собственной исключительности.",
      tactics: "1. Бережная конфронтация с Ложным Я. 2. Работа со стыдом. 3. Укрепление реального селф."
    },
    burnout_protocol: {
      obs: "ПРОТОКОЛ ВЫГОРАНИЯ: Истощение всех метрик при запредельной энтропии. Система находится в фазе декомпенсации.",
      risk: "Клиническая депрессия, полный отказ систем жизнеобеспечения. Требуется немедленная стабилизация.",
      provocation: "Что если 'сдаться' — это сейчас самая смелая и правильная стратегия для вашего выживания?",
      trap: "Вторичная выгода: Болезнь как единственный легальный способ получить право на отдых и внимание.",
      transfer: "Депрессивный перенос. Клиент приносит в кабинет 'черную дыру' безнадежности.",
      tactics: "1. Снижение когнитивной нагрузки. 2. Режим 'сохранения энергии'. 3. Фармакологическая поддержка (реф)."
    },
    systemic_loyalty: {
      obs: "СИСТЕМНАЯ ЛОЯЛЬНОСТЬ: Бессознательная верность семейному сценарию дефицита или несчастья.",
      risk: "Саботаж любого значимого успеха (финансового или личного), чтобы не 'предавать' предков своим благополучием.",
      provocation: "Кому из ваших предков станет больно или стыдно, если вы станете по-настоящему свободным и богатым?",
      trap: "Вина выжившего: Клиент чувствует вину за то, что живет лучше, чем его родители или род.",
      transfer: "Триангуляция. Клиент пытается вовлечь терапевта в семейный конфликт как 'союзника'.",
      tactics: "1. Генограмма. 2. Работа с лояльностями. 3. Разрешающие фразы."
    },
    stable: {
      obs: "УСЛОВНАЯ СТАБИЛЬНОСТЬ: Система демонстрирует запас прочности, но в рамках жестко заданного привычного сценария.",
      risk: "Стагнация в 'Золотой Клетке'. Отказ от масштаба и подлинной реализации ради привычной безопасности.",
      provocation: "Какой огромный потенциал вы продолжаете саботировать, сохраняя эту комфортную, но тесный стабильность?",
      trap: "Контракт на понимание: Согласие 'просто говорить' годами, избегая риска любого живого действия.",
      transfer: "Невротический перенос. Клиент ищет 'хорошего объекта' для безопасного существования.",
      tactics: "1. Провокация действия. 2. Исследование Тени. 3. Выход за пределы зоны комфорта."
    }
  },
  ka: {
    critical_foundation: {
      obs: "საყრდენების კრიტიკული დეფიციტი: პიროვნების საყრდენი კონსტრუქციების ცვეთა. სისტემა მუშაობს გადარჩენის რეჟიმში.",
      risk: "ფსიქოსომატური ჩავარდნის ან ნერვული გამოფიტვის მაღალი რისკი დატვირთვის მატებისას.",
      provocation: "ხვალ რომ შეწყვიტოთ 'სარგებლიანობა' და 'ფუნქციონირება', ვინ დარჩება ამ ცარიელ სივრცეში?",
      trap: "მაშველის მახე: კლიენტი შეეცდება თერაპევტი აქციოს თავის ერთადერთ საყრდენად და ამით შეაჩეროს რეალური ზრდა.",
      transfer: "იდეალიზაცია / გაუფასურება.",
      tactics: "სეტინგის დაცვა, სტაბილიზაცია."
    },
    manic_defense: {
      obs: "მანიაკალური დაცვა: მაღალი აგენტობა (ნება) ცარიელი საძირკვლის ფონზე. გაქცევა აქტივობაში შინაგანი ტკივილისგან.",
      risk: "უეცარი დეპრესიული ჩავარდნა (Crash).",
      provocation: "კონკრეტულად რომელი სიჩუმისგან გარბიხართ?",
      trap: "თერაპიული აზარტი.",
      transfer: "კონკურენტული ტრანსფერი.",
      tactics: "შენელება, ფოკუსი სიცარიელეზე."
    },
    frozen_state: {
      obs: "გაყინული პოტენციალი: ნების პარალიზი მაღალი ენტროპიის ფონზე.",
      risk: "აუტოაგრესია, სომატიზაცია.",
      provocation: "რა მოხდება, თუ ბრაზს უფლებას მისცემთ გამოვიდეს?",
      trap: "ინტელექტუალური გვერდის ავლა.",
      transfer: "პასიურ-აგრესიული.",
      tactics: "ბრაზთან მუშაობა."
    },
    dissociation: {
      obs: "სომატური გაწყვეტა: კავშირის არარსებობა არჩევანსა და სხეულს შორის.",
      risk: "საჭიროებებთან კონტაქტის დაკარგვა.",
      provocation: "სად მთავრდება თქვენი 'მე'?",
      trap: "ფორმალური ალიანსი.",
      transfer: "გათიშული ტრანსფერი.",
      tactics: "სომატური ფოკუსირება."
    },
    narcissistic_expansion: {
      obs: "ნარცისული გაფართოება: მაღალი რესურსი და ნება სუსტი საყრდენების ფონზე.",
      risk: "მწვავე სირცხვილი მარცხისას.",
      provocation: "ვინ ხართ, როცა არავინ გიყურებთ?",
      trap: "კონტრტრანსფერი: სიბრმავე კლიენტის ბრწყინვალების გამო.",
      transfer: "სარკისებრი ტრანსფერი.",
      tactics: "სირცხვილთან მუშაობა."
    },
    burnout_protocol: {
      obs: "გადაწვის პროტოკოლი: ყველა მეტრიკის გამოფიტვა.",
      risk: "კლინიკური დეპრესია.",
      provocation: "რა მოხდება, თუ დანებდებით?",
      trap: "მეორადი სარგებელი.",
      transfer: "დეპრესიული ტრანსფერი.",
      tactics: "ენერგიის დაზოგვა."
    },
    systemic_loyalty: {
      obs: "სისტემური ლოიალობა: ქვეცნობიერი ერთგულება ოჯახური დეფიციტისადმი.",
      risk: "წარმატების საბოტაჟი.",
      provocation: "თქვენს რომელ წინაპარს შერცხვება, თუ გამდიდრდებით?",
      trap: "გადარჩენილის დანაშაული.",
      transfer: "ტრიანგულაცია.",
      tactics: "გეონოგრამა, ლოიალობები."
    },
    stable: {
      obs: "პირობითი სტაბილურობა: სისტემა აჩვენებს მდგრადობას სცენარის ფარგლებში.",
      risk: "სტაგნაცია 'ოქროს გალიაში'.",
      provocation: "რომელ პოტენციალს აგრძელებთ საბოტაჟს?",
      trap: "გაგების კონტრაქტი.",
      transfer: "ნევროტული ტრანსფერი.",
      tactics: "ქმედების პროვოკაცია."
    }
  }
};

export const GeminiService = {
  async generateClinicalSupervision(result: AnalysisResult, lang: 'ru' | 'ka'): Promise<string> {
    await new Promise(resolve => setTimeout(resolve, 1500)); // LAB grade computation time

    const t = SUPERVISOR_PATTERNS[lang];
    const { state, neuroSync, activePatterns } = result;
    const f = state.foundation;
    const a = state.agency;
    const r = state.resource;
    const e = state.entropy;

    let pattern = t.stable; 
    
    // Complex synthesis logic (Core logic remains deterministic but expanded)
    if (f < 20 && e > 80) pattern = t.burnout_protocol;
    else if (f < 35) pattern = t.critical_foundation;
    else if (a > 80 && f < 45) pattern = t.manic_defense;
    else if (a > 80 && r > 70 && f < 50) pattern = t.narcissistic_expansion;
    else if (a < 35 && e > 45) pattern = t.frozen_state;
    else if (neuroSync < 45) pattern = t.dissociation;
    else if (activePatterns.includes('family_loyalty')) pattern = t.systemic_loyalty;

    let report = "";
    const headers = lang === 'ru' ? 
        ["АНАЛИЗ СТРУКТУРЫ", "КЛИНИЧЕСКИЙ РИСК", "ТЕРАПЕВТИЧЕСКАЯ ЛОВУШКА", "ПРОВОКАЦИЯ РОСТА", "ПРОГНОЗ ПЕРЕНОСА (LAB)", "ТАКТИЧЕСКИЙ ПЛАН (LAB)"] : 
        ["სტრუქტურის ანალიზი", "კლინიკური რისკი", "თერაპიული მახე", "ზრდის პროვოკაცია", "ტრანსფერის პროგნოზი", "ტაქტიკური გეგმა"];

    report += `### ${headers[0]}\n${pattern.obs}\n\n`;
    report += `### ${headers[1]}\n${pattern.risk}\n\n`;
    report += `### ${headers[2]}\n${pattern.trap}\n\n`;
    report += `### ${headers[3]}\n${pattern.provocation}\n\n`;
    
    // LAB Exclusive sections
    if (pattern.transfer) {
        report += `### ${headers[4]}\n${pattern.transfer}\n\n`;
    }
    if (pattern.tactics) {
        report += `### ${headers[5]}\n${pattern.tactics}`;
    }

    return report;
  }
};
