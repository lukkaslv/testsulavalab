import { AnalysisResult } from "../types";

// Genesis OS v3.5 - Professional Clinical Supervisor (Deterministic Logic)
// All insights are based on complex combinations of Foundation, Agency, Resource, Entropy and Somatic markers.

const SUPERVISOR_PATTERNS = {
  ru: {
    critical_foundation: {
      obs: "КРИТИЧЕСКИЙ ДЕФИЦИТ ОПОР: Обнаружен износ несущих конструкций личности. Система работает в режиме выживания.",
      risk: "Высокий риск психосоматического обрушения или нервного истощения при малейшем повышении нагрузки.",
      provocation: "Если завтра вы перестанете быть 'полезным' и 'функционирующим', кто останется в этом пустом пространстве?",
      trap: "Ловушка 'Спасательства': Клиент будет пытаться сделать терапевта своей единственной опорой, саботируя рост."
    },
    manic_defense: {
      obs: "МАНИАКАЛЬНАЯ ЗАЩИТА: Высокая Агентность (Воля) при пустом фундаменте. Бегство в деятельность от внутренней боли.",
      risk: "Внезапное депрессивное обрушение (Crash), когда компенсаторные механизмы исчерпают биологический ресурс.",
      provocation: "От какой именно тишины или внутренней боли вы бежите с такой огромной скоростью?",
      trap: "Терапевтический азарт: Терапевт может увлечься 'успехами' клиента, не замечая его нарастающего истощения."
    },
    frozen_state: {
      obs: "ЗАМОРОЖЕННЫЙ ПОТЕНЦИАЛ: Паралич воли на фоне высокой энтропии. Энергия системы тратится на сдерживание аффекта.",
      risk: "Аутоагрессия, соматизация (боли в теле без причины), хроническая усталость как способ не чувствовать ярость.",
      provocation: "Что самое страшное случится, если вы разрешите своей ярости выйти наружу хотя бы на секунду?",
      trap: "Интеллектуальный обход: Клиент будет бесконечно 'понимать' свои проблемы, используя это как защиту от действия."
    },
    dissociation: {
      obs: "СОМАТИЧЕСКИЙ РАЗРЫВ: Отсутствие связи между когнитивным выбором и реакцией тела. Интеллектуализация как бункер.",
      risk: "Потеря контакта с реальностью потребностей. Выгорание, которое будет замечено слишком поздно.",
      provocation: "Опишите физическое ощущение вашего 'Я' прямо сейчас. Где именно оно заканчивается?",
      trap: "Формальный альянс: Клиент будет играть роль 'образцового пациента', но терапия не будет проникать вглубь."
    },
    narcissistic_expansion: {
      obs: "НАРЦИССИЧЕСКОЕ РАСШИРЕНИЕ: Высокий ресурс и воля при хрупких опорах. Потребность в постоянном подтверждении грандиозности.",
      risk: "Острый стыд при любой неудаче, обесценивание терапии и специалиста при столкновении с реальностью.",
      provocation: "Кто вы такой, когда на вас никто не смотрит и никто вами не восхищается?",
      trap: "Контрперенос: Терапевт может чувствовать себя либо ничтожным, либо ослепленным блеском клиента."
    },
    burnout_protocol: {
      obs: "ПРОТОКОЛ ВЫГОРАНИЯ: Истощение всех метрик при запредельной энтропии. Система находится в фазе декомпенсации.",
      risk: "Клиническая депрессия, полный отказ систем жизнеобеспечения. Требуется немедленная стабилизация.",
      provocation: "Что если 'сдаться' — это сейчас самая смелая и правильная стратегия для вашего выживания?",
      trap: "Вторичная выгода: Болезнь как единственный легальный способ получить право на отдых и внимание."
    },
    systemic_loyalty: {
      obs: "СИСТЕМНАЯ ЛОЯЛЬНОСТЬ: Бессознательная верность семейному сценарию дефицита или несчастья.",
      risk: "Саботаж любого значимого успеха (финансового или личного), чтобы не 'предавать' предков своим благополучием.",
      provocation: "Кому из ваших предков станет больно или стыдно, если вы станете по-настоящему свободным и богатым?",
      trap: "Вина выжившего: Клиент чувствует вину за то, что живет лучше, чем его родители или род."
    },
    stable: {
      obs: "УСЛОВНАЯ СТАБИЛЬНОСТЬ: Система демонстрирует запас прочности, но в рамках жестко заданного привычного сценария.",
      risk: "Стагнация в 'Золотой Клетке'. Отказ от масштаба и подлинной реализации ради привычной безопасности.",
      provocation: "Какой огромный потенциал вы продолжаете саботировать, сохраняя эту комфортную, но тесную стабильность?",
      trap: "Контракт на понимание: Согласие 'просто говорить' годами, избегая риска любого живого действия."
    }
  },
  ka: {
    critical_foundation: {
      obs: "საყრდენების კრიტიკული დეფიციტი: პიროვნების საყრდენი კონსტრუქციების ცვეთა. სისტემა მუშაობს გადარჩენის რეჟიმში.",
      risk: "ფსიქოსომატური ჩავარდნის ან ნერვული გამოფიტვის მაღალი რისკი დატვირთვის მატებისას.",
      provocation: "ხვალ რომ შეწყვიტოთ 'სარგებლიანობა' და 'ფუნქციონირება', ვინ დარჩება ამ ცარიელ სივრცეში?",
      trap: "მაშველის მახე: კლიენტი შეეცდება თერაპევტი აქციოს თავის ერთადერთ საყრდენად და ამით შეაჩეროს რეალური ზრდა."
    },
    manic_defense: {
      obs: "მანიაკალური დაცვა: მაღალი აგენტობა (ნება) ცარიელი საძირკვლის ფონზე. გაქცევა აქტივობაში შინაგანი ტკივილისგან.",
      risk: "უეცარი დეპრესიული ჩავარდნა (Crash), როდესაც კომპენსატორული მექანიზმები ამოწურავენ ბიოლოგიურ რესურსს.",
      provocation: "კონკრეტულად რომელი სიჩუმისგან ან შინაგანი ტკივილისგან გარბიხართ ასეთი დიდი სიჩქარით?",
      trap: "თერაპიული აზარტი: თერაპევტმა შეიძლება დაიჯეროს კლიენტის 'წარმატებები' და ვერ შეამჩნიოს მისი გამოფიტვა."
    },
    frozen_state: {
      obs: "გაყინული პოტენციალი: ნების პარალიზი მაღალი ენტროპიის ფონზე. ენერგია იხარჯება აფექტის შეკავებაზე.",
      risk: "აუტოაგრესია, სომატიზაცია, ქრონიკული დაღლილობა - როგორც ბრაზის არ-გრძნობის საშუალება.",
      provocation: "რა მოხდება ყველაზე საშინელი, თუ თქვენს ბრაზს უფლებას მისცემთ გამოვიდეს გარეთ თუნდაც ერთი წამით?",
      trap: "ინტელექტუალური გვერდის ავლა: კლიენტი დაუსრულებლად 'გაიგებს' თავის პრობლემებს, რაც ქმედებისგან დაცვაა."
    },
    dissociation: {
      obs: "სომატური გაწყვეტა: კავშირის არარსებობა კოგნიტურ არჩევანსა და სხეულის რეაქციას შორის. ინტელექტუალიზაცია როგორც ბუნკერი.",
      risk: "საჭიროებების რეალობასთან კონტაქტის დაკარგვა. გადაწვა, რომელიც ძალიან გვიან იქნება შემჩნეული.",
      provocation: "აღწერეთ თქვენი 'მე'-ს ფიზიკური შეგრძნება ახლავე. სად მთავრდება ის?",
      trap: "ფორმალური ალიანსი: კლიენტი იქნება 'იდეალური პაციენტი', მაგრამ თერაპია სიღრმეში ვერ შეაღწევს."
    },
    narcissistic_expansion: {
      obs: "ნარცისული გაფართოება: მაღალი რესურსი და ნება სუსტი საყრდენების ფონზე. გრანდიოზულობის მუდმივი დადასტურების საჭიროება.",
      risk: "მწვავე სირცხვილი მარცხისას, თერაპიის გაუფასურება რეალობასთან შეჯახებისას.",
      provocation: "ვინ ხართ მაშინ, როცა არავინ გიყურებთ და არავინ აღფრთოვანდება თქვენით?",
      trap: "კონტრტრანსფერი: თერაპევტმა შეიძლება თავი იგრძნოს ან არარაობად, ან კლიენტის ბრწყინვალებით დაბრმავებულად."
    },
    burnout_protocol: {
      obs: "გადაწვის პროტოკოლი: ყველა მეტრიკის გამოფიტვა უკიდურესი ენტროპიის ფონზე. სისტემა დეკომპენსაციის ფაზაშია.",
      risk: "კლინიკური დეპრესია, სასიცოცხლო სისტემების სრული გათიშვა. საჭიროა სასწრაფო სტაბილიზაცია.",
      provocation: "რა მოხდება, თუ 'დანებება' ახლა ყველაზე მამაცი და სწორი სტრატეგიაა თქვენი გადარჩენისთვის?",
      trap: "მეორადი სარგებელი: ავადმყოფობა, როგორც დასვენებისა და ყურადღების მიღების ერთადერთი ლეგალური გზა."
    },
    systemic_loyalty: {
      obs: "სისტემური ლოიალობა: ქვეცნობიერი ერთგულება ოჯახური დეფიციტის ან უბედურების სცენარისადმი.",
      risk: "ნებისმიერი მნიშვნელოვანი წარმატების საბოტაჟი, რათა არ მოხდეს წინაპრების 'ღალატი' კეთილდღეობით.",
      provocation: "თქვენს რომელ წინაპარს ეტკინება ან შერცხვება, თუ თქვენ გახდებით ნამდვილად თავისუფალი და მდიდარი?",
      trap: "გადარჩენილის დანაშაული: კლიენტი გრძნობს დანაშაულს იმის გამო, რომ ცხოვრობს უკეთ, ვიდრე მისი გვარი."
    },
    stable: {
      obs: "პირობითი სტაბილურობა: სისტემა აჩვენებს მდგრადობას, მაგრამ მხოლოდ ნაცნობი სცენარის ფარგლებში.",
      risk: "სტაგნაცია 'ოქროს გალიაში'. მასშტაბზე უარის თქმა ნაცნობი უსაფრთხოების გამო.",
      provocation: "რომელი უზარმაზარი პოტენციალის საბოტაჟს აგრძელებთ ამ კომფორტული, მაგრამ ვიწრო სტაბილურობის შესანარჩუნებლად?",
      trap: "გაგების კონტრაქტი: შეთანხმება 'უბრალოდ საუბარზე' რეალური ქმედების რისკის გარეშე."
    }
  }
};

export const GeminiService = {
  async generateClinicalSupervision(result: AnalysisResult, lang: 'ru' | 'ka'): Promise<string> {
    await new Promise(resolve => setTimeout(resolve, 1000));

    const t = SUPERVISOR_PATTERNS[lang];
    const { state, neuroSync, activePatterns } = result;
    const f = state.foundation;
    const a = state.agency;
    const r = state.resource;
    const e = state.entropy;

    let pattern = t.stable; 
    
    // Complex synthesis logic
    if (f < 20 && e > 80) pattern = t.burnout_protocol;
    else if (f < 35) pattern = t.critical_foundation;
    else if (a > 80 && f < 45) pattern = t.manic_defense;
    else if (a > 80 && r > 70 && f < 50) pattern = t.narcissistic_expansion;
    else if (a < 35 && e > 45) pattern = t.frozen_state;
    else if (neuroSync < 45) pattern = t.dissociation;
    else if (activePatterns.includes('family_loyalty')) pattern = t.systemic_loyalty;

    let report = "";
    const headers = lang === 'ru' ? 
        ["АНАЛИЗ СТРУКТУРЫ", "КЛИНИЧЕСКИЙ РИСК", "ТЕРАПЕВТИЧЕСКАЯ ЛОВУШКА", "ПРОВОКАЦИЯ РОСТА"] : 
        ["სტრუქტურის ანალიზი", "კლინიკური რისკი", "თერაპიული მახე", "ზრდის პროვოკაცია"];

    report += `### ${headers[0]}\n${pattern.obs}\n\n`;
    report += `### ${headers[1]}\n${pattern.risk}\n\n`;
    report += `### ${headers[2]}\n${pattern.trap}\n\n`;
    report += `### ${headers[3]}\n${pattern.provocation}`;

    return report;
  }
};
