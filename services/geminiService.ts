
import { AnalysisResult } from "../types";

// Genesis OS v3.8 - Professional Clinical Supervisor (LAB GRADE)
// Deterministic Expert System for Supervisor Protocols.

const SUPERVISOR_PATTERNS = {
  ru: {
    critical_foundation: {
      obs: "КЛИНИЧЕСКАЯ КАРТИНА: 'ОГОЛЕННЫЙ НЕРВ'. Система демонстрирует критический дефицит базовых опор (Foundation < 35), что свидетельствует о глубокой структурной дезинтеграции Эго и отсутствии надежных внутренних объектов. Это состояние 'психической невесомости', где личность не имеет внутреннего 'скелета' для поддержания целостности под давлением. Функционирование происходит в режиме перманентного выживания, где вся энергия уходит на предотвращение полного коллапса. Паттерн 'Голый Провод' проявляется в том, что любой внешний стимул (критика, изменение планов, неопределенность) вызывает непропорционально сильную, запредельную реакцию из-за отсутствия внутреннего 'контейнера' для переработки аффекта. Клиент буквально 'прошибает током' от любого контакта с реальностью, не имея психологической 'изоляции'.",
      risk: "ПРОГНОЗИРУЕМЫЕ РИСКИ: 1. Краткосрочные: Высокий риск декомпенсации при малейшем увеличении стрессовой нагрузки. Возможны острые тревожные состояния, панические атаки или психосоматическое обрушение (например, мигрени, синдром раздраженного кишечника). 2. Долгосрочные: Риск развития клинической депрессии из-за хронического истощения нервной системы. Существует опасность формирования зависимых (аддиктивных) отношений как отчаянной попытки обрести внешнюю опору и контейнер для своих чувств. 3. Терапевтические: Высокая вероятность преждевременного прерывания терапии при первой же фрустрации или столкновении с необходимостью сепарации.",
      provocation: "ЦЕНТРАЛЬНАЯ ПРОВОКАЦИЯ (для долгосрочной стратегии): 'Что, если ваша главная задача сейчас — не бороться, не строить и не справляться, а позволить себе быть спасенным? И что самое страшное в том, чтобы признать свою тотальную беспомощность перед другим человеком и довериться ему?' Эта интервенция направлена на легализацию регресса и потребности в зависимости как необходимого этапа для последующего роста.",
      trap: "ТЕРАПЕВТИЧЕСКАЯ ЛОВУШКА: 'Слияние со Спасателем'. Клиент будет бессознательно провоцировать терапевта на принятие родительской, спасающей роли. Это временно снизит тревогу клиента, но полностью заблокирует процесс сепарации и интроекции 'хорошего объекта'. Терапевт может испытывать сильный контрперенос: от чувства всемогущества и грандиозности ('только я могу его спасти') до полного истощения и желания избавиться от 'слишком тяжелого' клиента. Важно отслеживать эти чувства как диагностический маркер.",
      transfer: "ПРОГНОЗ ПЕРЕНОСА: Ожидается архаичный, доэдипальный перенос. Клиент будет проецировать на терапевта фигуру 'Идеальной Матери', ища безусловного принятия, заботы и отражения. Любая фрустрация, установление границ (например, соблюдение времени сессии, оплата) может быть воспринята как катастрофическое отвержение, что немедленно приведет к регрессу, отыгрыванию вовне или яростному обесцениванию терапевта ('вы такой же, как все').",
      tactics: "ТАКТИЧЕСКИЙ ПЛАН 'ИНКУБАТОР': 1. Сеттинг как Контейнер: Максимальная стабильность, предсказуемость и надежность сеттинга. Недопустимы переносы сессий или опоздания со стороны терапевта. Это формирует первичный опыт безопасности. 2. Валидация, а не Интервенция: Приоритет — признание права на боль, беспомощность и регресс без попыток 'починить' или 'дать совет'. Фразы 'Я вижу, как вам больно' или 'Это действительно очень тяжело' являются основными инструментами. 3. Соматический Якорь: Постоянный фокус на телесных ощущениях ('Что сейчас происходит в теле? Где вы это чувствуете?') для восстановления контакта с реальностью и базовыми опорами. Тело — единственная опора, которая есть всегда."
    },
    manic_defense: {
      obs: "КЛИНИЧЕСКАЯ КАРТИНА: 'ПОЛЕТ НА ПУСТОМ БАКЕ'. Система использует гиперактивность, многозадачность и 'достигаторство' (Agency > 80) как основную маниакальную защиту от невыносимого чувства внутренней пустоты, ничтожности или депрессивного аффекта, связанных с дефицитом опор (Foundation < 45). Воля (Agency) используется не для аутентичного роста, а для бегства от себя. Скорость и продуктивность маскируют отсутствие 'топлива' (внутреннего ресурса и смысла). Эффективность в данном случае является не ресурсом, а симптомом, который необходимо исследовать, а не подкреплять.",
      risk: "ПРОГНОЗИРУЕМЫЕ РИСКИ: 1. Психические: Критический риск внезапного депрессивного обрушения (Crash), когда компенсаторные механизмы исчерпают биологический и психический ресурс. Этот 'крэш' часто воспринимается клиентом как полная неожиданность. 2. Соматические: Высокая вероятность психосоматических расстройств, связанных с хроническим стрессом (проблемы с сердцем, ЖКТ, бессонница) и тотального выгорания. Клиент абсолютно слеп к сигналам собственного истощения. 3. Социальные: Разрыв значимых отношений, которые не выдерживают заданного темпа, эмоциональной отстраненности и функционального подхода клиента.",
      provocation: "КЛЮЧЕВАЯ ИНТЕРВЕНЦИЯ: 'Я вижу вашу огромную силу, скорость и впечатляющие результаты. Это вызывает уважение. Но мне любопытно: от какой именно тишины, от какой внутренней правды или от какого чувства вы бежите с такой невероятной скоростью? Что самое страшное может случиться, если вы остановитесь и прислушаетесь к себе хотя бы на одну минуту?'",
      trap: "ТЕРАПЕВТИЧЕСКАЯ ЛОВУШКА: 'Восторг от 'идеального' клиента'. Специалист может быть соблазнен 'успехами', скоростью и продуктивностью клиента, подкрепляя его маниакальную защиту вместо ее исследования. Контрперенос: ощущение восхищения, желание 'учиться' у клиента или, наоборот, зависть и конкуренция. Терапевт рискует стать еще одним 'инструментом' в функциональном мире клиента.",
      transfer: "ПРОГНОЗ ПЕРЕНОСА: Соревновательный или нарциссический перенос. Клиент будет бессознательно пытаться 'победить' терапевта в осознанности, скорости инсайтов или 'правильности' выполнения техник. Терапия рискует превратиться в еще одно поле для достижений, а не в пространство для уязвимости и встречи с собой. Возможна идеализация терапевта как 'самого эффективного' с последующим обесцениванием, если терапия потребует замедления.",
      tactics: "ТАКТИЧЕСКИЙ ПЛАН 'ЗАМЕДЛЕНИЕ': 1. Конфронтация с темпом: Прямое и постоянное указание на скорость как на защиту. 'Давайте остановимся здесь', 'Куда мы так спешим?'. 2. Работа с пустотой: Исследование пауз, молчания, моментов 'не-делания' в сессии как основного терапевтического материала. 3. Легализация 'неэффективности': Дать разрешение на отдых, слабость, ошибки и право 'просто быть', а не 'функционировать'."
    },
    frozen_state: {
      obs: "КЛИНИЧЕСКАЯ КАРТИНА: 'ПАРАЛИЗОВАННЫЙ ГИГАНТ'. Значительный внутренний потенциал (Ресурс) полностью заблокирован высоким уровнем энтропии (внутреннего конфликта, тревоги). Система тратит большую часть энергии не на движение вперед, а на сдерживание мощного, но подавленного аффекта (чаще всего — гнева или ярости). Это состояние 'гражданской войны' внутри психики, где две равные по силе части парализуют друг друга, приводя к внешнему бездействию (Agency < 35).",
      risk: "ПРОГНОЗИРУЕМЫЕ РИСКИ: 1. Соматизация: Высокий риск соматизации, так как невыраженная энергия 'бьет по телу'. Возможны хронические боли, мышечные зажимы (особенно в челюсти и плечах), мигрени, фибромиалгия, аутоиммунные реакции. 2. Пассивная агрессия: Не находя прямого выхода, гнев будет проявляться в пассивной агрессии в отношениях, сарказме, цинизме и самосаботаже как способе косвенно выразить протест против 'несправедливости' мира.",
      provocation: "КЛЮЧЕВАЯ ИНТЕРВЕНЦИЯ: 'Представьте на секунду, что вся та огромная энергия, которая сейчас уходит на сдерживание и контроль, освободилась. Против кого или против чего на самом деле направлена эта титаническая сила, которую вы так тщательно держите в узде? Что самое страшное случится, если позволить ей проявиться?'",
      trap: "ТЕРАПЕВТИЧЕСКАЯ ЛОВУШКА: 'Интеллектуальное болото'. Клиент будет бесконечно анализировать, рефлексировать и 'понимать' свои проблемы, используя это как изощренный способ избежать живой встречи с замороженным аффектом. Терапевт рискует увязнуть в этих рассуждениях, теряя терапевтический драйв и становясь соучастником интеллектуализации.",
      transfer: "ПРОГНОЗ ПЕРЕНОСА: Пассивно-агрессивный перенос. Терапевт будет ощущать иррациональное раздражение, скуку, сонливость или бессилие во время сессий. Это клиент бессознательно 'передает' ему свою заблокированную агрессию и паралич воли. Возникает сильное контрпереносное желание 'толкать', 'спасать' или 'встряхнуть' клиента, что будет лишь усиливать его сопротивление.",
      tactics: "ТАКТИЧЕСКИЙ ПЛАН 'РАЗМОРОЗКА': 1. Легализация гнева: Создание безопасного пространства для выражения злости, сначала вербально. Работа с правом на гнев. 2. Парадоксальные интервенции: 'Разрешите себе ничего не менять', 'Какие есть выгоды в том, чтобы оставаться на месте?'. Это снижает сопротивление. 3. Фокус на амбивалентности: Исследование и усиление внутреннего конфликта между желанием перемен и страхом перед ними, не пытаясь его 'решить'."
    },
    dissociation: {
      obs: "КЛИНИЧЕСКАЯ КАРТИНА: 'ГОЛОВА ПРОФЕССОРА ДОУЭЛЯ'. Наблюдается выраженная диссоциация (NeuroSync < 45) между когнитивными процессами и телесными/эмоциональными реакциями. Интеллект функционирует отдельно от 'живого' опыта. Клиент 'рассказывает' о чувствах, вместо того чтобы их 'проживать'. Он может говорить 'мне было грустно' с абсолютно спокойным лицом и ровным дыханием. Это часто является следствием раннего травматического опыта, где 'отключиться' от тела и чувств было единственным способом выжить.",
      risk: "ПРОГНОЗИРУЕМЫЕ РИСКИ: 1. Потеря контакта с реальностью своих потребностей, что ведет к хроническому самоигнорированию и выгоранию. 2. Риск принятия жизненно важных решений (о выборе партнера, работы, места жительства) на основе 'правильных' идей и социальных конструктов, а не внутреннего отклика. Это приводит к глубинному ощущению 'не своей жизни', пустоте и депрессии. 3. Алекситимия: неспособность распознавать и описывать собственные эмоции.",
      provocation: "КЛЮЧЕВАЯ ИНТЕРВЕНЦИЯ: 'Спасибо за ваш подробный рассказ. А теперь давайте сделаем паузу. Если бы ваше тело могло говорить прямо сейчас, не спрашивая разрешения у вашего блестящего ума, что бы оно сказало о нашей беседе? Какой самый главный сигнал от своего тела вы игнорируете прямо сейчас?'",
      trap: "ТЕРАПЕВТИЧЕСКАЯ ЛОВУШКА: 'Формальный альянс'. Клиент может быть очень кооперативным, 'правильным', соглашаться со всеми интерпретациями и даже читать рекомендованную литературу, создавая иллюзию продуктивной работы. Однако терапия остается на поверхностном, интеллектуальном уровне, не затрагивая ядро проблемы. Контрперенос: ощущение 'стеклянной стены' между собой и клиентом, чувство скуки или профессиональной некомпетентности.",
      transfer: "ПРОГНОЗ ПЕРЕНОСА: Нарциссический (выключенный) или функциональный перенос. Клиент относится к терапевту как к функции, инструменту для 'починки' или источнику информации. Эмоциональная связь не формируется. Терапевт может чувствовать себя невидимым, использованным или превращенным в объект. Отсутствие 'химии' в контакте.",
      tactics: "ТАКТИЧЕСКИЙ ПЛАН 'ВОПЛОЩЕНИЕ' (EMBODIMENT): 1. Радикальная соматическая фокусировка: Постоянный возврат к телесным ощущениям ('Что сейчас происходит в теле? Где? Как оно дышит?'). 2. Прерывание потока речи: Мягкая, но настойчивая остановка 'историй' и ментальных конструкций с возвратом в 'здесь и сейчас'. 3. Работа с метафорами и образами, которые соединяют ум и тело."
    },
    stable: {
      obs: "КЛИНИЧЕСКАЯ КАРТИНА: 'ЗОЛОТАЯ КЛЕТКА'. Система демонстрирует достаточный запас прочности (все метрики в 'зеленой зоне'), но функционирует в рамках жесткого, привычного и безопасного сценария. Рост, масштабирование и выход на новый уровень бессознательно саботируются ради сохранения предсказуемости и избегания экзистенциальной тревоги, связанной с неизвестностью. Это невротическая организация личности с сильными защитными механизмами.",
      risk: "ПРОГНОЗИРУЕМЫЕ РИСКИ: Основной риск — стагнация и упущенные возможности. Жизнь 'на ручнике'. Постепенное нарастание ощущения бессмысленности, скуки, 'дня сурка'. В долгосрочной перспективе это может привести к депрессии среднего возраста, кризису идентичности или к тому, что клиент начнет разрушать свою стабильность иррациональными поступками (измены, резкая смена профессии без подготовки), чтобы вырваться из 'клетки'.",
      provocation: "КЛЮЧЕВАЯ ИНТЕРВЕНЦИЯ: 'Представьте, что ваш текущий, стабильный и безопасный мир — это уютная, хорошо обставленная комната. Какую огромную, пугающую, но манящую вселенную вы оставляете за дверью этой комнаты, боясь даже приоткрыть ее? Какой потенциал вы предаете, оставаясь в этой безопасности?'",
      trap: "ТЕРАПЕВТИЧЕСКАЯ ЛОВУШКА: 'Контракт на понимание'. Терапевт и клиент могут заключить негласное соглашение 'просто говорить' и 'анализировать' годами, избегая риска любого реального действия в жизни. Это создает комфортную иллюзию терапевтической работы без реальных изменений, что выгодно обеим сторонам для избегания тревоги. Терапия становится еще одним элементом 'золотой клетки'.",
      transfer: "ПРОГНОЗ ПЕРЕНОСА: Классический невротический перенос. Клиент будет искать в терапевте 'хороший объект' (родительскую фигуру), который одобрит его стратегию избегания, или 'эксперта', который даст 'правильный' и безопасный план, снимая с него ответственность за риск. Задача терапевта — фрустрировать этот запрос и возвращать ответственность за выбор.",
      tactics: "ТАКТИЧЕСКИЙ ПЛАН 'ПРОВОКАЦИЯ К ДЕЙСТВИЮ': 1. Исследование Тени: Анализ того, что клиент считает 'плохим', 'неправильным', 'неприемлемым' в себе и других. Именно там скрыта энергия для роста. 2. Работа с вторичными выгодами: 'Что хорошего в том, чтобы оставаться на месте? От какой катастрофы это вас спасает?'. 3. Экзистенциальная конфронтация: Работа с темами свободы, ответственности, смерти и смысла жизни."
    },
    narcissistic_expansion: {
      obs: "НАРЦИССИЧЕСКОЕ РАСШИРЕНИЕ: Высокий ресурс и воля при хрупких опорах. Потребность в постоянном подтверждении грандиозности.",
      risk: "Острый стыд при любой неудаче, обесценивание терапии и специалиста при столкновении с реальностью.",
      provocation: "Кто вы такой, когда на вас никто не смотрит и никто вами не восхищается?",
      trap: "Контрперенос: Терапевт может чувствовать себя либо ничтожным, либо ослепленным блеском клиента.",
      transfer: "Зеркальный перенос. Поиск в терапевте подтверждения собственной исключительности.",
      tactics: "1. Бережная конфронтация с Ложным Я. 2. Работа со стыдом. 3. Укрепление реального селф."
    },
    burnout_protocol: {
      obs: "ПРОТОКОЛ ВЫГОРАНИЯ: Истощение всех метрик при запредельной энтропии. Система находится в фазе декомпенсации.",
      risk: "Клиническая депрессия, полный отказ систем жизнеобеспечения. Требуется немедленная стабилизация.",
      provocation: "Что если 'сдаться' — это сейчас самая смелая и правильная стратегия для вашего выживания?",
      trap: "Вторичная выгода: Болезнь как единственный легальный способ получить право на отдых и внимание.",
      transfer: "Депрессивный перенос. Клиент приносит в кабинет 'черную дыру' безнадежности.",
      tactics: "1. Снижение когнитивной нагрузки. 2. Режим 'сохранения энергии'. 3. Фармакологическая поддержка (реф)."
    },
    systemic_loyalty: {
      obs: "СИСТЕМНАЯ ЛОЯЛЬНОСТЬ: Бессознательная верность семейному сценарию дефицита или несчастья.",
      risk: "Саботаж любого значимого успеха (финансового или личного), чтобы не 'предавать' предков своим благополучием.",
      provocation: "Кому из ваших предков станет больно или стыдно, если вы станете по-настоящему свободным и богатым?",
      trap: "Вина выжившего: Клиент чувствует вину за то, что живет лучше, чем его родители или род.",
      transfer: "Триангуляция. Клиент пытается вовлечь терапевта в семейный конфликт как 'союзника'.",
      tactics: "1. Генограмма. 2. Работа с лояльностями. 3. Разрешающие фразы."
    }
  },
  ka: { 
    critical_foundation: {
      obs: "საყრდენების კრიტიკული დეფიციტი: პიროვნების საყრდენი კონსტრუქციების ღრმა ცვეთა. სისტემა მუშაობს გადარჩენის რეჟიმში, შინაგანი 'კონტეინერის' გარეშე.",
      risk: "ფსიქოსომატური ჩავარდნის ან ნერვული გამოფიტვის მაღალი რისკი. მოსალოდნელია დამოკიდებული ურთიერთობების ფორმირება.",
      provocation: "რა მოხდება, თუ საკუთარ თავს სრულ უმწეობაში გამოუტყდებით?",
      trap: "მაშველის მახე: კლიენტი შეეცდება თერაპევტი აქციოს თავის ერთადერთ საყრდენად და ამით შეაჩეროს რეალური ზრდა.",
      transfer: "არქაული, პრე-ედიპალური გადაცემა. 'იდეალური დედის' პროექცია.",
      tactics: "1. სეტინგის სტაბილიზაცია. 2. უმწეობის ვალიდაცია. 3. სომატური ფოკუსირება."
    },
    manic_defense: {
      obs: "მანიაკალური დაცვა: მაღალი აგენტობა (ნება) ცარიელი საძირკვლის ფონზე. გაქცევა აქტივობაში შინაგანი სიცარიელისგან. ეფექტურობა არის სიმპტომი და არა რესურსი.",
      risk: "უეცარი დეპრესიული ჩავარდნის (Crash) კრიტიკული რისკი. კლიენტი ბრმაა საკუთარი გამოფიტვის მიმართ.",
      provocation: "კონკრეტულად რომელი სიჩუმისგან გარბიხართ ასეთი დიდი სისწრაფით?",
      trap: "თერაპიული აღფრთოვანება: სპეციალისტი შეიძლება მოიხიბლოს კლიენტის 'წარმატებებით' და გააძლიეროს დაცვა.",
      transfer: "კონკურენტული ტრანსფერი. კლიენტი შეეცდება 'მოუგოს' თერაპევტს, აქცევს რა თერაპიას მორიგ მიღწევად.",
      tactics: "1. ტემპთან კონფრონტაცია. 2. შენელება. 3. 'არაეფექტურობის' ლეგალიზაცია."
    },
     frozen_state: {
      obs: "გაყინული პოტენციალი: ნების პარალიზი მაღალი ენტროპიის ფონზე. ენერგია იხარჯება ჩახშობილი აფექტის (ბრაზის) შეკავებაზე.",
      risk: "სომატიზაციის მაღალი რისკი (ქრონიკული ტკივილი), პასიური აგრესია და თვით-საბოტაჟი.",
      provocation: "წარმოიდგინეთ, რომ თქვენი შეკავებული ენერგია განთავისუფლდა. ვის წინააღმდეგ არის ის მიმართული?",
      trap: "ინტელექტუალური ჭაობი: კლიენტი უსასრულოდ გააანალიზებს პრობლემებს, რათა თავი აარიდოს გრძნობებთან შეხვედრას.",
      transfer: "პასიურ-აგრესიული გადაცემა. თერაპევტი იგრძნობს გაღიზიანებას და უძლურებას.",
      tactics: "1. ჩახშობილ ბრაზთან მუშაობა. 2. პარადოქსული ინტერვენციები. 3. ამბივალენტობის კვლევა."
    },
    dissociation: {
      obs: "სომატური გაწყვეტა: კავშირის არარსებობა კოგნიტურ არჩევანსა და სხეულებრივ რეაქციას შორის. ინტელექტი ფუნქციონირებს ცალკე.",
      risk: "საკუთარ საჭიროებებთან კონტაქტის დაკარგვა, რაც იწვევს ქრონიკულ თვით-იგნორირებას და გადაწვას.",
      provocation: "თქვენს სხეულს რომ შეეძლოს ლაპარაკი, რას იტყოდა ის ახლა?",
      trap: "ფორმალური ალიანსი. 'სამაგალითო პაციენტის' როლის თამაში, რაც თერაპიას ზედაპირულს ხდის.",
      transfer: "გათიშული გადაცემა. თერაპევტი იგრძნობს 'შუშის კედელს' კლიენტთან.",
      tactics: "1. სომატური ფოკუსირება. 2. მეტყველების ნაკადის შეწყვეტა. 3. მუშაობა 'აქ და ახლა' შეგრძნებებზე."
    },
    stable: {
        obs: "პირობითი სტაბილურობა: სისტემა მდგრადია, მაგრამ ფუნქციონირებს ხისტი, ნაცნობი სცენარის ('ოქროს გალიის') ფარგლებში.",
        risk: "სტაგნაცია და ხელიდან გაშვებული შესაძლებლობები. უაზრობის გრძნობის ზრდა.",
        provocation: "რომელ უზარმაზარ პოტენციალს ახდენთ საბოტაჟს, ამ კომფორტული, მაგრამ ვიწრო სტაბილურობის შენარჩუნებით?",
        trap: "გაგების კონტრაქტი: თერაპევტი და კლიენტი თანხმდებიან, რომ 'ისაუბრონ' წლობით, რეალური მოქმედების რისკის გარეშე.",
        transfer: "კლასიკური ნევროტული გადაცემა. კლიენტი ეძებს 'კარგ ობიექტს' ან 'ექსპერტს', რომელიც პასუხისმგებლობას აიღებს.",
        tactics: "1. მოქმედების პროვოცირება. 2. ჩრდილის კვლევა. 3. კომფორტის ზონიდან გასვლა."
    },
    narcissistic_expansion: { obs: "ნარცისული გაფართოება", risk: "მწვავე სირცხვილი მარცხისას", provocation: "ვინ ხართ, როცა არავინ გიყურებთ?", trap: "კონტრტრანსფერი: სიბრმავე", transfer: "სარკისებრი ტრანსფერი", tactics: "სირცხვილთან მუშაობა" },
    burnout_protocol: { obs: "გადაწვის პროტოკოლი", risk: "კლინიკური დეპრესია", provocation: "რა მოხდება, თუ დანებდებით?", trap: "მეორადი სარგებელი", transfer: "დეპრესიული ტრანსფერი", tactics: "ენერგიის დაზოგვა" },
    systemic_loyalty: { obs: "სისტემური ლოიალობა", risk: "წარმატების საბოტაჟი", provocation: "რომელ წინაპარს შერცხვება?", trap: "გადარჩენილის დანაშაული", transfer: "ტრიანგულაცია", tactics: "გეონოგრამა, ლოიალობები" }
  }
};

export const GeminiService = {
  async generateClinicalSupervision(result: AnalysisResult, lang: 'ru' | 'ka'): Promise<string> {
    await new Promise(resolve => setTimeout(resolve, 1500)); 

    const t = SUPERVISOR_PATTERNS[lang];
    const { state, neuroSync, activePatterns } = result;
    const f = state.foundation;
    const a = state.agency;
    const r = state.resource;
    const e = state.entropy;

    let patternKey: keyof typeof t = 'stable'; 
    
    if (f < 20 && e > 80) patternKey = 'burnout_protocol';
    else if (f < 35) patternKey = 'critical_foundation';
    else if (a > 80 && f < 45) patternKey = 'manic_defense';
    else if (a > 80 && r > 70 && f < 50) patternKey = 'narcissistic_expansion';
    else if (a < 35 && e > 45) patternKey = 'frozen_state';
    else if (neuroSync < 45) patternKey = 'dissociation';
    else if (activePatterns.includes('family_loyalty')) patternKey = 'systemic_loyalty';

    const pattern = t[patternKey];

    const reportTitle = lang === 'ru' ? "**КЛИНИЧЕСКИЙ ДОКЛАД СУПЕРВИЗОРА**" : "**სუპერვაიზერის კლინიკური მოხსენება**";
    const headers = lang === 'ru' ? 
        ["1. Клиническая картина", "2. Прогнозируемые риски", "3. Терапевтическая ловушка и контрперенос", "4. Ключевая интервенция (Провокация)", "5. Прогноз динамики переноса", "6. Тактический план на первые сессии"] : 
        ["1. კლინიკური სურათი", "2. პროგნოზირებადი რისკები", "3. თერაპიული ხაფანგი და კონტრტრანსფერი", "4. საკვანძო ინტერვენცია (პროვოკაცია)", "5. გადაცემის დინამიკის პროგნოზი", "6. ტაქტიკური გეგმა პირველი სესიებისთვის"];

    let report = `${reportTitle}\n\n`;
    report += `**${headers[0]}:**\n${pattern.obs}\n\n`;
    report += `**${headers[1]}:**\n${pattern.risk}\n\n`;
    report += `**${headers[2]}:**\n${pattern.trap}\n\n`;
    report += `**${headers[3]}:**\n${pattern.provocation}\n\n`;
    
    if (pattern.transfer) {
        report += `**${headers[4]}:**\n${pattern.transfer}\n\n`;
    }
    if (pattern.tactics) {
        report += `**${headers[5]}:**\n${pattern.tactics}`;
    }

    return report;
  }
};
