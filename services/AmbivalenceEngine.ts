
import { GameHistoryItem, BeliefKey, DomainType } from '../types';
import { WEIGHTS } from './psychologyService';

export interface УзелАмбивалентности {
    узелId: string;
    название: string;
    сфера: DomainType;
    трение: number; // Латентность выше нормы (0-100)
    диссоциация: number; // Тяжесть соматического блока (0-100)
    интенсивность: number; // Общий вес конфликта
    убеждение: BeliefKey;
}

export interface ОтчетАмбивалентности {
    точки: УзелАмбивалентности[];
    индексРасщепления: number; // Среднее по системе
    доминантаКонфликта: DomainType | 'НЕТ';
    вердикт: string;
}

/**
 * ГЕНЕЗИС: ЯДРО АМБИВАЛЕНТНОСТИ v1.0
 * Детерминированный поиск "узлов лжи" (Ст. 3.1)
 */
export const AmbivalenceEngine = {
    анализировать(история: GameHistoryItem[], базовоеВремя: number): ОтчетАмбивалентности {
        if (история.length < 5) {
            return { точки: [], индексРасщепления: 0, доминантаКонфликта: 'НЕТ', вердикт: "Данных недостаточно" };
        }

        const точки: УзелАмбивалентности[] = история.map(h => {
            // Трение = насколько задержка превышает базу (нормировано до 100)
            const трение = Math.min(100, Math.max(0, (h.latency - базовоеВремя) / 20));
            
            // Диссоциация = вес соматического отклика
            // s0: 0, s1: 40, s2: 10, s3: 20, s4: 80
            const сомаВеса: Record<string, number> = { s0: 0, s1: 50, s2: 10, s3: 30, s4: 90 };
            const диссоциация = сомаВеса[h.sensation] || 0;

            // Интенсивность = геометрическое среднее трения и диссоциации + вес убеждения
            const w = (WEIGHTS as any)[h.beliefKey] || WEIGHTS.default;
            const весУбеждения = (Math.abs(w.f) + Math.abs(w.a) + Math.abs(w.e)) * 5;
            
            const интенсивность = Math.min(100, Math.round((трение * 0.4 + диссоциация * 0.6) + весУбеждения / 2));

            return {
                узелId: h.nodeId,
                название: h.beliefKey,
                сфера: h.domain,
                трение: Math.round(трение),
                диссоциация,
                интенсивность,
                убеждение: h.beliefKey as BeliefKey
            };
        }).filter(t => t.интенсивность > 30); // Порог значимости конфликта

        const индекс = точки.length > 0 
            ? Math.round(точки.reduce((acc, t) => acc + t.интенсивность, 0) / точки.length)
            : 0;

        // Поиск доминанты
        const сферы = точки.map(t => t.сфера);
        const доминанта = сферы.length > 0 
            ? сферы.sort((a,b) => сферы.filter(v => v===a).length - сферы.filter(v => v===b).length).pop() || 'foundation'
            : 'НЕТ';

        let вердикт = "Конфликты минимальны. Система когерентна.";
        if (индекс > 70) вердикт = "ТОТАЛЬНОЕ РАСЩЕПЛЕНИЕ: Ум и Тело находятся в состоянии войны. Словам клиента нельзя доверять.";
        else if (индекс > 45) вердикт = "ЛОКАЛЬНЫЕ ОЧАГИ: Обнаружены зоны активного вытеснения, требующие проработки.";
        else if (точки.length > 5) вердикт = "РАССЕЯННОЕ НАПРЯЖЕНИЕ: Клиент испытывает общую тревогу перед тестированием.";

        return {
            точки: точки.sort((a,b) => b.интенсивность - a.интенсивность),
            индексРасщепления: индекс,
            доминантаКонфликта: доминанта as DomainType | 'НЕТ',
            вердикт
        };
    }
};
