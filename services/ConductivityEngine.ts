
import { RawAnalysisResult, DomainType } from '../types';
import { calculateViscosity } from './psychologyService';

export type СтатусШлюза = 'ПРОЗРАЧЕН' | 'ПРОНИЦАЕМ' | 'ВЯЗОК' | 'ЗАБЛОКИРОВАН';

export interface ДанныеШлюза {
    домен: DomainType;
    проводимость: number; // 0-100
    статус: СтатусШлюза;
    рекомендация: string;
}

export interface ОтчетПроводимости {
    шлюзы: ДанныеШлюза[];
    точкаВхода: DomainType;
    общийРезонанс: number;
    вердикт: string;
}

/**
 * ГЕНЕЗИС: ЯДРО КЛИНИЧЕСКОЙ ПРОВОДИМОСТИ v1.0
 * Детерминированный поиск точки наименьшего сопротивления (Ст. 1.1)
 */
export const ConductivityEngine = {
    рассчитать(результат: RawAnalysisResult): ОтчетПроводимости {
        const вязкость = calculateViscosity(результат);
        const домены: DomainType[] = ['foundation', 'agency', 'money', 'social', 'legacy'];
        
        const шлюзы: ДанныеШлюза[] = домены.map(d => {
            const v = вязкость.perDomain[d];
            const sync = результат.neuroSync;
            
            // Проводимость = Инверсия вязкости, усиленная нейросинком
            // (100 - вязкость) дает базу, нейросинк дает коэффициент "пропуска"
            const проводимость = Math.round((100 - v) * 0.7 + (sync * 0.3));
            
            let статус: СтатусШлюза = 'ВЯЗОК';
            // FIX: Changed cyrillic 'рек' to latin 'rek' to avoid 'Cannot find name rek' error
            let rek = "Требуется длительная подготовка.";
            
            if (проводимость > 85) {
                статус = 'ПРОЗРАЧЕН';
                rek = "Идеальная точка для быстрой трансформации.";
            } else if (проводимость > 60) {
                статус = 'ПРОНИЦАЕМ';
                rek = "Хороший потенциал для глубокой работы.";
            } else if (проводимость < 30) {
                статус = 'ЗАБЛОКИРОВАН';
                rek = "Риск высокой ретравматизации. Обходите эту зону.";
            }

            return { домен: d, проводимость, статус, рекомендация: rek };
        });

        const отсортированные = [...шлюзы].sort((a, b) => b.проводимость - a.проводимость);
        const точкаВхода = отсортированные[0].домен;
        const резонанс = Math.round(шлюзы.reduce((acc, ш) => acc + ш.проводимость, 0) / 5);

        let вердикт = "Система находится в режиме накопления, шлюзы прикрыты.";
        if (резонанс > 70) вердикт = "ОКНО ВОЗМОЖНОСТЕЙ: Психика готова к тотальному обновлению. Действуйте решительно.";
        else if (резонанс < 40) вердикт = "РЕЖИМ ОБОРОНЫ: Высокая ригидность всех каналов. Прямые интервенции будут отвергнуты.";

        return {
            шлюзы: отсортированные,
            точкаВхода,
            общийРезонанс: резонанс,
            вердикт
        };
    }
};