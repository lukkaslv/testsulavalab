
import { GameHistoryItem, DomainType } from '../types';

export interface ОчагИзноса {
    домен: DomainType;
    температура: number; // 0-100 (Уровень перегрева)
    износ: number; // 0-100 (Накопленное повреждение)
    критичность: boolean;
}

export interface ОтчетСдвига {
    очаги: ОчагИзноса[];
    общаяТемпература: number;
    доминантаПерегрева: DomainType;
    вердикт: string;
}

/**
 * ГЕНЕЗИС: ЯДРО ТЕРМИЧЕСКОГО СДВИГА v1.0
 * Детерминированный расчет "Психического Трения" (Ст. 3.1)
 */
export const ThermalShiftEngine = {
    рассчитать(история: GameHistoryItem[], энтропия: number): ОтчетСдвига {
        const домены: DomainType[] = ['foundation', 'agency', 'money', 'social', 'legacy'];
        
        const очаги: ОчагИзноса[] = домены.map(d => {
            const узлыДомена = история.filter(h => h.domain === d);
            if (узлыДомена.length === 0) return { домен: d, температура: 0, износ: 0, критичность: false };

            // Температура = Средняя латентность в домене / 30
            const средняяЛатентность = узлыДомена.reduce((acc, h) => acc + h.latency, 0) / узлыДомена.length;
            const температура = Math.min(100, Math.round(средняяЛатентность / 40));

            // Износ = Количество соматических блоков (s1, s4) + влияние общей энтропии
            const блоки = узлыДомена.filter(h => h.sensation === 's1' || h.sensation === 's4').length;
            const износ = Math.min(100, Math.round((блоки * 20) + (энтропия * 0.4)));

            return {
                домен: d,
                температура,
                износ,
                критичность: температура > 70 || износ > 75
            };
        });

        const общаяТемп = Math.round(очаги.reduce((acc, o) => acc + o.температура, 0) / 5);
        const доминанта = [...очаги].sort((a, b) => b.температура - a.температура)[0].домен;

        let вердикт = "Система работает в штатном температурном режиме.";
        if (общаяТемп > 65) вердикт = "КРИТИЧЕСКИЙ ПЕРЕГРЕВ: Психика тратит колоссальный ресурс на удержание структуры. Риск обрушения.";
        else if (очаги.some(o => o.критичность)) вердикт = "ЛОКАЛЬНЫЙ ИЗНОС: Обнаружены зоны деформации, требующие немедленной разгрузки.";
        else if (общаяТемп > 40) вердикт = "ПОВЫШЕННОЕ ТРЕНИЕ: Система адаптирована, но работает на повышенных оборотах.";

        return {
            очаги,
            общаяТемпература: общаяТемп,
            доминантаПерегрева: доминанта,
            вердикт
        };
    }
};
