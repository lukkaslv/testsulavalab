
import { AnalysisResult } from '../types';

export interface ОтчетСверхсистемы {
    типВклада: string;
    векторСмысла: string;
    индексПроводимости: number;
    аттракторБудущего: string;
    резонансПоля: number;
}

/**
 * ЯДРО СВЕРХСИСТЕМЫ v1.0
 * Детерминированный расчет экзистенциального вклада (Ст. 1.1)
 */
export const SupersystemEngine = {
    анализировать(результат: AnalysisResult): ОтчетСверхсистемы {
        const { state, domainProfile, integrity } = результат;
        const { foundation: f, agency: a, resource: r, entropy: e } = state;

        // 1. Определение Типа Вклада (на основе макс. профицита)
        const профиль = [
            { домен: 'foundation', значение: f },
            { домен: 'agency', значение: a },
            { домен: 'money', значение: r },
            { домен: 'social', значение: domainProfile.social || 50 },
            { домен: 'legacy', значение: domainProfile.legacy || 50 }
        ].sort((x, y) => y.значение - x.значение);

        const доминанта = профиль[0].домен;
        
        const картыВклада: Record<string, string> = {
            foundation: "АРХИТЕКТОР БЕЗОПАСНОСТИ: Создание надежных структур и опор для других.",
            agency: "ДВИГАТЕЛЬ ПЕРЕМЕН: Инициация процессов трансформации в Сверхсистеме.",
            money: "ПРОВОДНИК ИЗОБИЛИЯ: Масштабирование ресурсов и управление потоками ценности.",
            social: "ГАРМОНИЗАТОР ПОЛЯ: Выстраивание связей и снижение энтропии в группе.",
            legacy: "ХРАНИТЕЛЬ СМЫСЛОВ: Передача фундаментальных ценностей будущим узлам."
        };

        // 2. Вектор Смысла (f(Integrity, Entropy))
        let вектор = "Стабилизация текущего узла.";
        if (integrity > 75 && e < 30) вектор = "Расширение проводимости. Ваша форма готова влиять на макро-структуры.";
        else if (integrity < 40) вектор = "Саморегуляция. Ваша задача в Сверхсистеме сейчас — не разрушить себя.";
        else if (e > 60) вектор = "Преобразование хаоса. Вы — фильтр, очищающий поле от шума.";

        // 3. Индекс Проводимости (насколько система "прозрачна" для жизни)
        const проводимость = Math.round(integrity * (1 - e / 200));

        // 4. Аттрактор Будущего (обратная причинность)
        let аттрактор = "Сохранение гомеостаза.";
        if (a > 70) аттрактор = "Создание Нового Порядка.";
        if (r > 70) аттрактор = "Трансцендентный вклад в Род.";
        if (f > 80 && a > 80) аттрактор = "Инженерная Этика Жизни.";

        return {
            типВклада: картыВклада[доминанта] || "УТОЧНЕНИЕ...",
            векторСмысла: вектор,
            индексПроводимости: проводимость,
            аттракторБудущего: аттрактор,
            резонансПоля: Math.round((proportional(a, 0.4) + proportional(integrity, 0.6)) * (1 - e/150))
        };
    }
};

function proportional(val: number, weight: number): number {
    return val * weight;
}
