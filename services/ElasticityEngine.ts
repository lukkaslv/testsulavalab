
import { GameHistoryItem } from '../types';

export interface ТочкаВосстановления {
    узелId: string;
    напряжение: number; // 0-100
    остаток: number; // Насколько "эхо" предыдущего блока влияет сейчас
}

export interface ОтчетУпругости {
    индексУпругости: number; // 0-100%
    времяЗатухания: number; // Среднее кол-во узлов для возврата в норму
    рискЗатопления: boolean;
    вердикт: string;
    график: ТочкаВосстановления[];
}

/**
 * ГЕНЕЗИС: ЯДРО УПРУГОСТИ v1.0
 * Детерминированный анализ затухания аффекта (Ст. 1.1)
 */
export const ElasticityEngine = {
    рассчитать(история: GameHistoryItem[]): ОтчетУпругости {
        if ( история.length < 10) {
            return { индексУпругости: 100, времяЗатухания: 0, рискЗатопления: false, вердикт: "Недостаточно данных", график: [] };
        }

        const латентности = история.map(h => h.latency);
        const средняя = латентности.reduce((a, b) => a + b, 0) / латентности.length;
        
        let суммарнаяУпругость = 0;
        let замеры = 0;
        const график: ТочкаВосстановления[] = [];

        for (let i = 2; i < история.length; i++) {
            const текущая = история[i];
            const предыд = история[i-1];
            
            // Если предыдущий узел был "тяжелым" (латентность > 1.5 от средней)
            if (предыд.latency > средняя * 1.5) {
                const эффектЭха = (текущая.latency / предыд.latency); // 0..1 (чем меньше, тем лучше восстановление)
                const упругостьУзла = Math.max(0, 100 - (эффектЭха * 100));
                
                суммарнаяУпругость += упругостьУзла;
                замеры++;
            }

            график.push({
                узелId: текущая.nodeId,
                напряжение: Math.min(100, (текущая.latency / (средняя * 2)) * 100),
                остаток: замеры > 0 ? (100 - (суммарнаяУпругость / замеры)) : 0
            });
        }

        const итоговыйИндекс = замеры > 0 ? Math.round(суммарнаяУпругость / замеры) : 100;
        const риск = итоговыйИндекс < 40;

        let вердикт = "Психика эластична. Быстрое возвращение в рабочее состояние.";
        if (риск) вердикт = "РИСК ЗАТОПЛЕНИЯ: Психика долго 'пережевывает' стресс, теряя контакт с реальностью.";
        else if (итоговыйИндекс < 65) вердикт = "ИЗНОС КОНТЕЙНЕРА: Медленное восстановление, требуется щадящий режим.";

        return {
            индексУпругости: итоговыйИндекс,
            времяЗатухания: риск ? 4 : 1,
            // FIX: Исправлено смешение латиницы и кириллицы в названии свойства (risкЗатопления -> рискЗатопления)
            рискЗатопления: риск,
            вердикт,
            график
        };
    }
};
