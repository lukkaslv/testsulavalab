import { AnalysisResult, DomainType } from '../types';

export interface ПараметрыРезонанса {
    индексЛояльности: number; // Насколько клиент "слит" с системой
    уровеньДифференциации: number; // Способность быть отдельным
    давлениеПоля: number; // Внешняя нагрузка от рода/социума
    узлыСцепленности: Array<{ сфера: DomainType, сила: number }>;
    вердикт: string;
}

/**
 * ЯДРО СИСТЕМНОГО РЕЗОНАНСА v1.0
 * Соответствие: Ст. 3.1, Ст. 4.2
 */
export const SystemicResonanceEngine = {
    рассчитать(результат: AnalysisResult): ПараметрыРезонанса {
        const { state, domainProfile, activePatterns } = результат;
        const { foundation: опора, agency: воля, entropy: хаос } = state;

        // Расчет лояльности: Опора + Наследие против Воли
        const наследие = domainProfile.legacy || 50;
        const лояльность = Math.round((наследие * 0.6 + опора * 0.4) * (1 - воля / 200));
        
        // Дифференциация: Способность воли противостоять давлению наследия
        const дифференциация = Math.round(воля * (1 - лояльность / 150));

        // Давление поля: Высокий хаос при низкой воле
        const давление = Math.round((хаос * 0.7) + (100 - воля) * 0.3);

        const узлы: Array<{ сфера: DomainType, сила: number }> = [
            { сфера: 'legacy', сила: лояльность },
            { сфера: 'foundation', сила: Math.round(опора * 0.8) },
            { сфера: 'agency', сила: воля }
        ];

        let вердикт = "Система находится в балансе с окружением.";
        if (лояльность > 75) вердикт = "КРИТИЧЕСКАЯ СЦЕПЛЕННОСТЬ: Личность поглощена родовой динамикой. Суверенитет ограничен.";
        else if (дифференциация < 30) вердикт = "ДЕФИЦИТ АВТОНОМИИ: Высокая чувствительность к ожиданиям системы.";
        else if (давление > 70) вердикт = "СИСТЕМНЫЙ ПЕРЕГРЕВ: Поле требует больше энергии, чем есть у субъекта.";

        return {
            индексЛояльности: лояльность,
            уровеньДифференциации: дифференциация,
            давлениеПоля: давление,
            узлыСцепленности: узлы,
            вердикт
        };
    }
};