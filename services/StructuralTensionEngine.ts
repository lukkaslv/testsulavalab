
import { GameHistoryItem, DomainType } from '../types';

export interface СвязьНатяжения {
    от: DomainType;
    к: DomainType;
    сила: number; // 0-100 (Насколько сильно сферы влияют друг на друга)
    напряжение: number; // 0-100 (Уровень конфликта в связи)
    статус: 'ПОТОК' | 'НАТЯЖЕНИЕ' | 'РАЗРЫВ';
}

export interface ОтчетНатяжения {
    связи: СвязьНатяжения[];
    индексСцепления: number;
    доминантаДеформации: DomainType;
    вердикт: string;
}

/**
 * ГЕНЕЗИС: ЯДРО СТРУКТУРНОГО НАТЯЖЕНИЯ v1.0
 * Детерминированный расчет "Архитектуры Удержания" (Ст. 3.1)
 */
export const StructuralTensionEngine = {
    рассчитать(история: GameHistoryItem[]): ОтчетНатяжения {
        const домены: DomainType[] = ['foundation', 'agency', 'money', 'social', 'legacy'];
        const связи: СвязьНатяжения[] = [];
        
        // Анализируем пары доменов (Ст. 4.2)
        for (let i = 0; i < домены.length; i++) {
            for (let j = i + 1; j < домены.length; j++) {
                const d1 = домены[i];
                const d2 = домены[j];
                
                const узлы1 = история.filter(h => h.domain === d1);
                // FIX: Changed 'history' to 'история' to fix Property 'filter' does not exist on type 'History'
                const узлы2 = история.filter(h => h.domain === d2);
                
                if (узлы1.length === 0 || узлы2.length === 0) continue;

                // Напряжение связи = средняя разница латентности между доменами
                const средняяЛат1 = узлы1.reduce((acc, h) => acc + h.latency, 0) / узлы1.length;
                const средняяЛат2 = узлы2.reduce((acc, h) => acc + h.latency, 0) / узлы2.length;
                
                const напряжение = Math.min(100, Math.abs(средняяЛат1 - средняяЛат2) / 30);
                const сила = Math.round((средняяЛат1 + средняяЛат2) / 80);

                связи.push({
                    от: d1,
                    к: d2,
                    сила: Math.min(100, сила),
                    напряжение: Math.round(напряжение),
                    статус: напряжение > 70 ? 'РАЗРЫВ' : напряжение > 40 ? 'НАТЯЖЕНИЕ' : 'ПОТОК'
                });
            }
        }

        const среднееНатяжение = связи.reduce((acc, s) => acc + s.напряжение, 0) / связи.length;
        const доминанта = домены.sort((a, b) => {
            const nA = связи.filter(s => s.от === a || s.к === a).reduce((acc, s) => acc + s.напряжение, 0);
            const nB = связи.filter(s => s.от === b || s.к === b).reduce((acc, s) => acc + s.напряжение, 0);
            return nB - nA;
        })[0];

        let вердикт = "Структура пластична. Свободная циркуляция энергии.";
        if (среднееНатяжение > 60) вердикт = "КРИТИЧЕСКАЯ РИГИДНОСТЬ: Система держится на предельном усилии. Любое изменение грозит обвалом.";
        else if (связи.some(s => s.статус === 'РАЗРЫВ')) вердикт = "ЛОКАЛЬНАЯ ДЕФОРМАЦИЯ: Обнаружены разрывы связности. Сферы изолированы друг от друга.";
        else if (среднееНатяжение > 30) вердикт = "ПОВЫШЕННЫЙ ТОНУС: Психика находится в состоянии постоянной мобилизации.";

        return {
            связи,
            индексСцепления: Math.round(среднееНатяжение),
            доминантаДеформации: доминанта,
            вердикт
        };
    }
};