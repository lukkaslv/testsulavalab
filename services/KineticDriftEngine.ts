
import { GameHistoryItem, DomainType } from '../types';
import { calculateRawMetrics } from './psychologyService';

export interface ОтчетДрейфа {
    скорость: number; // 0-100 (Интенсивность изменений за сессию)
    направление: 'СТАБИЛИЗАЦИЯ' | 'ДЕГРАДАЦИЯ' | 'СТАТИКА';
    активныйДомен: DomainType;
    прогнозСдвига: number; // Вероятность смены архетипа
    вердикт: string;
}

/**
 * ГЕНЕЗИС: ЯДРО КИНЕТИЧЕСКОГО ДРЕЙФА v1.0
 * Детерминированный анализ производной состояния (Ст. 3.1)
 */
export const KineticDriftEngine = {
    анализировать(история: GameHistoryItem[]): ОтчетДрейфа {
        if (история.length < 20) {
            return { скорость: 0, направление: 'СТАТИКА', активныйДомен: 'foundation', прогнозСдвига: 0, вердикт: "Данных для анализа дрейфа недостаточно." };
        }

        // 1. Берем сегменты: Начало (первые 10) и Финал (последние 10)
        const начало = история.slice(0, 15);
        const финал = история.slice(-15);

        const метрикиНачала = calculateRawMetrics(начало);
        const метрикиФинала = calculateRawMetrics(финал);

        // 2. Расчет Дельты Целостности
        const дельта = метрикиФинала.integrity - метрикиНачала.integrity;
        const скорость = Math.min(100, Math.abs( дельта ) * 4);

        // 3. Направление
        let направление: ОтчетДрейфа['направление'] = 'СТАТИКА';
        if (дельта > 3) направление = 'СТАБИЛИЗАЦИЯ';
        else if (дельта < -3) направление = 'ДЕГРАДАЦИЯ';

        // 4. Поиск самого волатильного домена
        const домены: DomainType[] = ['foundation', 'agency', 'money', 'social', 'legacy'];
        let максСдвиг = -1;
        let активный: DomainType = 'foundation';

        домены.forEach(d => {
            const dDelta = Math.abs(метрикиФинала.domainProfile[d] - метрикиНачала.domainProfile[d]);
            if (dDelta > максСдвиг) {
                максСдвиг = dDelta;
                активный = d;
            }
        });

        // 5. Прогноз смены архетипа (на основе энтропии и дельты)
        const прогноз = Math.min(100, Math.round(скорость + метрикиФинала.state.entropy / 2));

        let вердикт = "Система сохраняет высокую инерцию. Состояние устойчиво.";
        if (направление === 'ДЕГРАДАЦИЯ') вердикт = "УТОМЛЕНИЕ ЗАЩИТ: К концу сессии клиент теряет ресурс. Результаты финала более истинны, чем начала.";
        else if (направление === 'СТАБИЛИЗАЦИЯ') вердикт = "ТЕРАПЕВТИЧЕСКИЙ РЕЗОНАНС: Процесс теста выравнивает систему. Клиент адаптируется к осознанию.";
        if (скорость > 60) вердикт = "ВЫСОКАЯ ТЕКУЧЕСТЬ: Личность находится в точке бифуркации. Текущий срез крайне нестабилен.";

        return {
            скорость: Math.round(скорость),
            направление,
            активныйДомен: активный,
            прогнозСдвига: прогноз,
            вердикт
        };
    }
};
