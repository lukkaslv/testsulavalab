
import { AnalysisResult, Translations, BeliefKey } from "../types";

/**
 * –ì–ï–ù–ï–ó–ò–°: –ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –°—É–ø–µ—Ä–≤–∏–∑–æ—Ä v2.5
 * –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –Ω–∞—Ä—Ä–∞—Ç–∏–≤–Ω—ã–π –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç.
 * Compliance: Art. 3 (Clinical Validity), Art. 12 (Russian Sovereignty)
 */
export const DossierService = {
  generateDossier(result: AnalysisResult, t: Translations): string {
    const { history, shareCode, state, neuroSync } = result;
    const { foundation: f, agency: a, resource: r, entropy: e } = state;

    let d = "";
    const NL = "\n";
    const L = "================================================================================\n";
    const S = "--------------------------------------------------------------------------------\n";

    // --- 1. –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–†–û–§–ò–õ–Ø (–ü–°–ò–•–û–î–ò–ù–ê–ú–ò–ö–ê) ---
    let profileType = "–ù–ï–í–†–û–¢–ò–ß–ï–°–ö–ò–ô (–ë–ê–ó–û–í–´–ô)";
    let profileDesc = "–ö–ª–∏–µ–Ω—Ç –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω, –Ω–æ —Ç—Ä–∞—Ç–∏—Ç —ç–Ω–µ—Ä–≥–∏—é –Ω–∞ –ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤.";
    let strategy = "–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤—Ç–æ—Ä–∏—á–Ω—ã—Ö –≤—ã–≥–æ–¥.";

    if (f < 30) {
        profileType = "–î–ï–§–ò–¶–ò–¢–ê–†–ù–´–ô (–ü–û–ì–†–ê–ù–ò–ß–ù–´–ô –°–ü–ï–ö–¢–†)";
        profileDesc = "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –Ω–µ—Ö–≤–∞—Ç–∫–∞ –±–∞–∑–æ–≤–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. '–Ø' —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ. –í—ã—Å–æ–∫–∞—è —Ç—Ä–µ–≤–æ–≥–∞.";
        strategy = "–ü–û–î–î–ï–†–ñ–ö–ê –ò –ö–û–ù–¢–ï–ô–ù–ò–†–û–í–ê–ù–ò–ï. –ù–∏–∫–∞–∫–æ–π –∫–æ–Ω—Ñ—Ä–æ–Ω—Ç–∞—Ü–∏–∏.";
    } else if (a > 80 && f < 45) {
        profileType = "–ö–û–ú–ü–ï–ù–°–ê–¢–û–†–ù–´–ô (–ù–ê–†–¶–ò–°–°–ò–ß–ï–°–ö–ò–ô –°–ü–ï–ö–¢–†)";
        profileDesc = "–ì—Ä–∞–Ω–¥–∏–æ–∑–Ω–æ–µ '–Ø' (–í–æ–ª—è) –ø—Ä–∏–∫—Ä—ã–≤–∞–µ—Ç —Ö—Ä—É–ø–∫—É—é —Å–∞–º–æ–æ—Ü–µ–Ω–∫—É (–§—É–Ω–¥–∞–º–µ–Ω—Ç). –ë–µ–≥—Å—Ç–≤–æ –≤ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –æ—Ç —Å—Ç—ã–¥–∞.";
        strategy = "–ê–∫–∫—É—Ä–∞—Ç–Ω–∞—è –∫–æ–Ω—Ñ—Ä–æ–Ω—Ç–∞—Ü–∏—è —Å —É—è–∑–≤–∏–º–æ—Å—Ç—å—é. –í–æ–∑–≤—Ä–∞—Ç –≤ —Ç–µ–ª–æ.";
    } else if (e > 70) {
        profileType = "–•–ê–û–¢–ò–ß–ï–°–ö–ò–ô (–î–ò–§–§–£–ó–ù–´–ô)";
        profileDesc = "–°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–≥—Ä–µ—Ç–∞. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–µ–∫—Ç–æ—Ä–∞. –ö–ª–∏–µ–Ω—Ç –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç, —á–µ–≥–æ —Ö–æ—á–µ—Ç.";
        strategy = "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ. –ü–æ–∏—Å–∫ –æ–¥–Ω–æ–π –º–∏–∫—Ä–æ-—Ü–µ–ª–∏.";
    } else if (neuroSync < 40) {
        profileType = "–î–ò–°–°–û–¶–ò–ê–¢–ò–í–ù–´–ô (–ò–ù–¢–ï–õ–õ–ï–ö–¢–£–ê–õ–ò–ó–ê–¶–ò–Ø)";
        profileDesc = "–ì–æ–ª–æ–≤–∞ –æ—Ç—Ä–µ–∑–∞–Ω–∞ –æ—Ç —Ç–µ–ª–∞. –ö–ª–∏–µ–Ω—Ç –≤—Å–µ '–ø–æ–Ω–∏–º–∞–µ—Ç', –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ —á—É–≤—Å—Ç–≤—É–µ—Ç.";
        strategy = "–†–∞–±–æ—Ç–∞ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Ç–µ–ª–æ –∏ –æ—â—É—â–µ–Ω–∏—è. –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.";
    }

    // --- 2. –¢–ò–¢–£–õ–¨–ù–´–ô –õ–ò–°–¢ ---
    d += L;
    d += `üß¨ –°–ò–°–¢–ï–ú–ê –ì–ï–ù–ï–ó–ò–° // –ö–õ–ò–ù–ò–ß–ï–°–ö–û–ï –î–û–°–¨–ï // –®–ò–§–†: ${shareCode.substring(0, 8)}\n`;
    d += `–ü–†–û–§–ò–õ–¨: ${profileType}\n`;
    d += L + NL;

    d += `[I. –°–¢–†–£–ö–¢–£–†–ù–´–ô –ê–ù–ê–õ–ò–ó]\n`;
    d += `–ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –≥–∏–ø–æ—Ç–µ–∑–∞: ${profileDesc}\n`;
    d += NL;
    d += `–°–û–°–¢–û–Ø–ù–ò–ï –°–ò–°–¢–ï–ú–´:\n`;
    d += `‚Ä¢ –û–ü–û–†–ê (${f}%): `;
    if (f < 35) d += `–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –î–ï–§–ò–¶–ò–¢.\n`;
    else if (f < 55) d += `–ù–ï–£–°–¢–û–ô–ß–ò–í–ê–Ø.\n`;
    else d += `–î–û–°–¢–ê–¢–û–ß–ù–ê–Ø.\n`;

    d += `‚Ä¢ –í–û–õ–Ø (${a}%): `;
    if (a > 80) d += `–ì–ò–ü–ï–†-–ö–û–ú–ü–ï–ù–°–ê–¶–ò–Ø.\n`;
    else if (a < 35) d += `–ü–ê–†–ê–õ–ò–ß –í–û–õ–ò.\n`;
    else d += `–ê–î–ê–ü–¢–ò–í–ù–ê–Ø.\n`;

    d += `‚Ä¢ –†–ï–°–£–†–° (${r}%): `;
    if (r < 40) d += `–ò–°–¢–û–©–ï–ù–ò–ï.\n`;
    else if (r > 70) d += `–ù–ê–ö–û–ü–õ–ï–ù–ò–ï.\n`;
    else d += `–ë–ê–õ–ê–ù–°.\n`;

    d += `‚Ä¢ –°–í–Ø–ó–¨ (${neuroSync}%): `;
    if (neuroSync < 45) d += `‚ÄºÔ∏è –†–ê–ó–†–´–í –° –¢–ï–õ–û–ú.\n`;
    else d += `–ö–û–ì–ï–†–ï–ù–¢–ù–û.\n`;
    
    d += NL + S;

    d += `[II. –¢–û–ß–ö–ò –í–•–û–î–ê –í –¢–ï–†–ê–ü–ò–Æ]\n`;
    const problemNodes = history
        .map(h => ({ ...h, score: (h.latency > 2500 ? (h.latency / 1000) : 0) + (h.sensation === 's1' || h.sensation === 's4' ? 5 : 0) }))
        .filter(h => h.score > 2)
        .sort((a, b) => b.score - a.score)
        .slice(0, 3);

    if (problemNodes.length === 0) d += `–ü–∏–∫–æ–≤ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.\n`;
    else {
        problemNodes.forEach((node, i) => {
            const belief = t.beliefs[node.beliefKey as BeliefKey] || node.beliefKey;
            d += `${i + 1}. –¢–ï–ú–ê: "${belief.toUpperCase()}" (${t.domains[node.domain]})\n`;
            d += `   –í–û–ü–†–û–°: "–ß—Ç–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ —Å–ª—É—á–∏—Ç—Å—è, –µ—Å–ª–∏ –≤—ã –æ—Ç–∫–∞–∂–µ—Ç–µ—Å—å –æ—Ç —É–±–µ–∂–¥–µ–Ω–∏—è '${belief}'?"\n\n`;
        });
    }
    d += S;

    d += `[III. –ü–†–û–¢–û–ö–û–õ –¢–ï–†–ê–ü–ò–ò]\n`;
    d += `–°–¢–†–ê–¢–ï–ì–ò–Ø: ${strategy}\n`;
    d += NL + L;
    d += `–ì–ï–ù–ï–ó–ò–° v27.5 // –î–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.`;
    
    return d;
  }
};
